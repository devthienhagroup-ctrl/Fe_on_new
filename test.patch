diff --git a/src/components/dich-vu/Phi-dich-vu.vue b/src/components/dich-vu/Phi-dich-vu.vue
index ef57120ed6c6b693239cfb9784cb6f5687019efe..981620fc50e40dcd52deb15c53177a3a0f13a984 100644
--- a/src/components/dich-vu/Phi-dich-vu.vue
+++ b/src/components/dich-vu/Phi-dich-vu.vue
@@ -519,140 +519,140 @@
                 </select>
               </div>
               <div class="field">
                 <label><i class="fa-solid fa-calendar-day"></i> Ng√†y ƒë√≥ng ti·ªÅn</label>
                 <input v-model="payment.date" type="date">
               </div>
               <div class="field">
                 <label><i class="fa-solid fa-note-sticky"></i> Ghi ch√∫</label>
                 <input v-model="payment.note" type="text" placeholder="VD: ƒê·ª£t 2">
               </div>
             </div>

             <div class="card">
               <div class="card-h"><i class="fa-solid fa-circle-info"></i> T√≥m t·∫Øt h·ª£p ƒë·ªìng</div>
               <div class="p-3">
                 <div class="text-sm font-extrabold">{{ currentContract?.maHopDong }} ‚Ä¢ {{ currentContract?.tenKhachHang }}</div>
                 <div class="muted tiny mt-1">{{ currentContract?.tenDichVu }} ‚Ä¢ Ng√†y t·∫°o {{ formatCreatedAt(currentContract?.ngayTao) }} ‚Ä¢ Tr·∫°ng th√°i {{ getStatusText(currentContract?.trangThaiHopDong) }}</div>

                 <div class="grid grid-cols-2 gap-2 mt-3">
                   <div class="kpi">
                     <div class="k"><span class="dot"></span>Gi√° sau gi·∫£m</div>
                     <div class="v price p4">{{ formatMoney(currentContract?.giaSauGiam || 0) }}</div>
                   </div>
                   <div class="kpi">
                     <div class="k"><span class="dot"></span>T·ªïng ƒëi·ªÅu ch·ªânh</div>
-                    <div class="v price p2">{{ formatMoney(calcTongDieuChinh(currentContract)) }}</div>
+                    <div class="v price p2">{{ formatMoney(getTongDieuChinh(currentContract)) }}</div>
                   </div>
                   <div class="kpi">
                   <div class="k"><span class="dot"></span>C√≤n thi·∫øu</div>
-                  <div class="v price p1">{{ formatMoney(calcConThieu(currentContract)) }}</div>
+                  <div class="v price p1">{{ formatMoney(getConThieu(currentContract)) }}</div>
                 </div>
                 <div class="kpi">
                   <div class="k"><span class="dot"></span>ƒê√£ thu</div>
                   <div class="v price p3">{{ formatMoney(getDoanhThuRow(currentContract)) }}</div>
                 </div>
                 </div>

                 <div class="note mt-3">
                   <b>L∆∞u √Ω:</b> ƒê√≥ng ph√≠ s·∫Ω l√†m tƒÉng <span class="mono">Th·ª±c thu</span>.
                 </div>
               </div>
             </div>
           </div>
         </div>

         <div class="modal-f">
           <button class="btn ghost" @click="closeModal('modalPay')">
             <i class="fa-solid fa-ban"></i> H·ªßy
           </button>
           <button class="btn primary" @click="savePayment">
             <i class="fa-solid fa-check"></i> X√°c nh·∫≠n ƒë√≥ng
           </button>
         </div>
       </div>
     </div>

     <!-- MODAL: REFUND -->
     <div class="modal" :class="{ show: showModal === 'modalRefund' }" @click.self="closeModal('modalRefund')">
       <div class="modal-card">
         <div class="modal-h">
           <div class="modal-title">
             <i class="fa-solid fa-arrow-rotate-left"></i>
             Ho√†n ph√≠
           </div>
           <button class="x" @click="closeModal('modalRefund')">
             <i class="fa-solid fa-xmark"></i>
           </button>
         </div>

         <div class="modal-b">
           <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
             <div class="card">
               <div class="card-h"><i class="fa-solid fa-reply"></i> Th√¥ng tin ho√†n</div>
               <div class="field">
                 <label><i class="fa-solid fa-money-bill-transfer"></i> S·ªë ti·ªÅn ho√†n</label>
                 <input
                   :value="formatNumberInput(refund.amount)"
                   type="text"
                   inputmode="numeric"
                   placeholder="VD: 500.000"
-                  @input="refund.amount = parseNumberInput($event.target.value)"
+                  @input="setRefundAmountFromInput($event.target.value)"
                 >
               </div>
               <div class="field">
                 <label><i class="fa-solid fa-calendar-day"></i> Ng√†y ho√†n</label>
                 <input v-model="refund.date" type="date">
               </div>
               <div class="field">
                 <label><i class="fa-solid fa-clipboard"></i> L√Ω do ho√†n</label>
                 <textarea v-model="refund.reason" placeholder="VD: Kh√°ch hu·ª∑ 1 ph·∫ßn..."></textarea>
               </div>
             </div>

             <div class="card">
               <div class="card-h"><i class="fa-solid fa-circle-info"></i> T√≥m t·∫Øt h·ª£p ƒë·ªìng</div>
               <div class="p-3">
                 <div class="text-sm font-extrabold">{{ currentContract?.maHopDong }} ‚Ä¢ {{ currentContract?.tenKhachHang }}</div>
                 <div class="muted tiny mt-1">{{ currentContract?.tenDichVu }} ‚Ä¢ Ng√†y t·∫°o {{ formatCreatedAt(currentContract?.ngayTao) }} ‚Ä¢ Tr·∫°ng th√°i {{ getStatusText(currentContract?.trangThaiHopDong) }}</div>

                 <div class="grid grid-cols-2 gap-2 mt-3">
                   <div class="kpi">
-                    <div class="k"><span class="dot"></span>Gi√° ƒëi·ªÅu ch·ªânh</div>
-                    <div class="v price p2">{{ formatMoney(calcGiaDieuChinh(currentContract)) }}</div>
+                    <div class="k"><span class="dot"></span>Gi√° sau gi·∫£m</div>
+                    <div class="v price p4">{{ formatMoney(currentContract?.giaSauGiam || 0) }}</div>
                   </div>
                   <div class="kpi">
-                    <div class="k"><span class="dot"></span>Th·ª±c thu</div>
-                    <div class="v price p3">{{ formatMoney(calcThucThu(currentContract)) }}</div>
+                    <div class="k"><span class="dot"></span>T·ªïng ƒëi·ªÅu ch·ªânh</div>
+                    <div class="v price p2">{{ formatMoney(getTongDieuChinh(currentContract)) }}</div>
                   </div>
                   <div class="kpi">
-                    <div class="k"><span class="dot"></span>Doanh thu (min)</div>
-                    <div class="v price p1">{{ formatMoney(calcDoanhThu(currentContract)) }}</div>
+                    <div class="k"><span class="dot"></span>C√≤n thi·∫øu</div>
+                    <div class="v price p1">{{ formatMoney(getConThieu(currentContract)) }}</div>
                   </div>
                   <div class="kpi">
-                    <div class="k"><span class="dot"></span>C√≤n thi·∫øu</div>
-                    <div class="v price p4">{{ formatMoney(Math.max(0, calcGiaDieuChinh(currentContract) - calcThucThu(currentContract))) }}</div>
+                    <div class="k"><span class="dot"></span>ƒê√£ thu</div>
+                    <div class="v price p3">{{ formatMoney(getDoanhThuRow(currentContract)) }}</div>
                   </div>
                 </div>

                 <div class="note mt-3">
                   <b>L∆∞u √Ω:</b> Ho√†n ph√≠ s·∫Ω l√†m gi·∫£m <span class="mono">Th·ª±c thu</span>.
                 </div>
               </div>
             </div>
           </div>
         </div>

         <div class="modal-f">
           <button class="btn ghost" @click="closeModal('modalRefund')">
             <i class="fa-solid fa-ban"></i> H·ªßy
           </button>
           <button class="btn primary" @click="saveRefund">
             <i class="fa-solid fa-check"></i> X√°c nh·∫≠n ho√†n
           </button>
         </div>
       </div>
     </div>

     <!-- MODAL: ADJUST -->
     <div class="modal" :class="{ show: showModal === 'modalAdjust' }" @click.self="closeModal('modalAdjust')">
       <div class="modal-card">
@@ -1184,50 +1184,64 @@ watch(() => newContract.value.serviceId, () => {

 watch(() => newContract.value.giaTriTaiSan, () => {
   updateGiaGocFromAsset()
 })

 watch(() => newContract.value.discountMode, () => {
   updateGiaSauGiam()
 })

 watch(() => payment.value.amount, (val) => {
   if (!currentContract.value) return

   const maxAmount = calcConThieu(currentContract.value)

   // üîë Parse ‚Üí √âP S·ªê NGUY√äN
   let num = Math.floor(parseNumberInput(val))

   if (num > maxAmount) num = maxAmount
   if (num < 0) num = 0

   if (num !== payment.value.amount) {
     payment.value.amount = num
   }
 })

+watch(() => refund.value.amount, (val) => {
+  if (!currentContract.value) return
+
+  const maxAmount = getMaxRefundAmount(currentContract.value)
+  let num = Math.floor(parseNumberInput(val))
+
+  if (num > maxAmount) num = maxAmount
+  if (num < 0) num = 0
+
+  if (num !== refund.value.amount) {
+    refund.value.amount = num
+  }
+})
+
 // Methods
 // Helper functions
 const formatMoney = (n) => {
   const x = Math.round(Number(n || 0))
   const sign = x < 0 ? '-' : ''
   const abs = Math.abs(x)
   return sign + abs.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.') + ' ‚Ç´'
 }

 const formatNumberInput = (n) => {
   if (n === null || n === undefined || n === '') return ''
   const x = Math.round(Number(n || 0))
   const sign = x < 0 ? '-' : ''
   const abs = Math.abs(x)
   return sign + abs.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.')
 }

 const parseNumberInput = (value, allowNegative = false) => {
   const raw = String(value || '').trim()
   if (!raw) return 0
   const noDots = raw.replace(/\./g, '')
   const cleaned = allowNegative ? noDots.replace(/[^0-9-]/g, '') : noDots.replace(/[^0-9]/g, '')
   let parsed = Number(cleaned)
   if (Number.isNaN(parsed)) parsed = 0
   if (!allowNegative) return Math.max(0, parsed)
@@ -1272,51 +1286,51 @@ const formatCreatedAt = (value) => {
   if (!Number.isNaN(parsed.getTime())) {
     return `${parsed.toLocaleTimeString('vi-VN')} ${parsed.toLocaleDateString('vi-VN')}`
   }
   return String(value)
 }

 const getGiaGiam = (contract) => {
   return Number(contract?.giaGiam ?? contract?.phiGiam ?? 0)
 }

 const getGiaTaiSanKy = (contract) => {
   return Number(contract?.giaTaiSanKyGoc ?? contract?.giaTriTaiSan ?? contract?.giaTriKyBan ?? 0)
 }

 const getTongHoan = (contract) => {
   if (contract?.giaHoanTien !== undefined && contract?.giaHoanTien !== null) {
     return Number(contract.giaHoanTien || 0)
   }
   return calcTongHoan(contract)
 }

 const getTongDieuChinh = (contract) => {
   if (contract?.tongDC !== undefined && contract?.tongDC !== null) {
     return Number(contract.tongDC || 0)
   }
-  return calcTongDieuChinh(contract)
+  return 0
 }

 const getDoanhThuRow = (contract) => {
   return Number(contract?.doanhThu ?? 0)
 }

 const getDoanhThu = (contract) => {
   if (contract?.doanhThu !== undefined && contract?.doanhThu !== null) {
     return Number(contract.doanhThu || 0)
   }
   return calcThucThu(contract)
 }

 const getDoanhSo = (contract) => {
   if (contract?.doanhSo !== undefined && contract?.doanhSo !== null) {
     return Number(contract.doanhSo || 0)
   }
   return calcDoanhThu(contract)
 }

 const randInt = (min, max) => {
   return Math.floor(Math.random() * (max - min + 1)) + min
 }

 const randPriceForService = (serviceName) => {
@@ -1418,57 +1432,65 @@ const genContractCode = () => {
 // Calculation functions
 const calcTongDong = (c) => {
   return (c?.dotDongTien || []).reduce((sum, x) => sum + (Number(x.soTienDong) || 0), 0)
 }

 const calcTongHoan = (c) => {
   return (c?.hoanTien || []).reduce((sum, x) => sum + (Number(x.soTienHoan) || 0), 0)
 }

 const calcTongDieuChinh = (c) => {
   return (c?.dieuChinh || []).reduce((sum, x) => sum + (Number(x.soTienDieuChinh) || 0), 0)
 }

 const calcThucThu = (c) => {
   return calcTongDong(c) - calcTongHoan(c)
 }

 const calcGiaDieuChinh = (c) => {
   return (Number(c?.giaSauGiam) || 0) + calcTongDieuChinh(c)
 }

 const calcDoanhThu = (c) => {
   return Math.min(calcGiaDieuChinh(c), calcThucThu(c))
 }

-const calcConThieu = (c) => {
+const getConThieu = (c) => {
   const giaSauGiam = Number(c?.giaSauGiam || 0)
   const tongDieuChinh = getTongDieuChinh(c)
   const doanhThu = getDoanhThuRow(c)
   return Math.max(0, giaSauGiam + tongDieuChinh - doanhThu)
 }

+const calcConThieu = (c) => {
+  return getConThieu(c)
+}
+
+const getMaxRefundAmount = (c) => {
+  return Math.max(0, getDoanhThuRow(c))
+}
+
 // Toast
 const showToastMessage = (type, title, text) => {
   toast.value = {
     type,
     title,
     text,
     icon: type === 'success' ? 'fa-solid fa-circle-check' :
         type === 'error' ? 'fa-solid fa-triangle-exclamation' :
             'fa-solid fa-circle-info'
   }
   showToast.value = true
   setTimeout(() => {
     showToast.value = false
   }, 3000)
 }

 // Modal control
 const openModal = (modal) => {
   showModal.value = modal
 }

 const closeModal = (modal) => {
   resetContractForm()
   if (showModal.value === modal) {
     showModal.value = null
@@ -1534,50 +1556,56 @@ const updateGiaSauGiam = () => {
     newContract.value.phiGiam = Math.round(giaGoc * (percent / 100))
   } else {
     const money = Number(newContract.value.discountValue || 0)
     const clamped = Math.max(0, Math.min(giaGoc, money))
     newContract.value.discountValue = clamped
     newContract.value.phiGiam = clamped
   }
   newContract.value.giaSauGiam = Math.max(0, giaGoc - (newContract.value.phiGiam || 0))
 }

 const setDiscountValueFromInput = (value) => {
   if (newContract.value.discountMode === 'PERCENT') {
     newContract.value.discountValue = parseNumberInput(value)
   } else {
     newContract.value.discountValue = parseNumberInput(value)
   }
   updateGiaSauGiam()
 }

 const setPaymentAmountFromInput = (value) => {
   const parsed = parseNumberInput(value)
   const maxAmount = calcConThieu(currentContract.value)
   payment.value.amount = Math.min(parsed, maxAmount)
 }

+const setRefundAmountFromInput = (value) => {
+  const parsed = parseNumberInput(value)
+  const maxAmount = getMaxRefundAmount(currentContract.value)
+  refund.value.amount = Math.min(parsed, maxAmount)
+}
+
 const clearSelectedCustomer = () => {
   selectedCustomer.value = null
   customerSearch.value = ''
   customerSearchResults.value = []
   customerSearchError.value = ''
   customerSearchLoading.value = false
   newContract.value.maKhachHang = ''
   newContract.value.tenKhachHang = ''
 }

 const fetchCustomerSearch = async (keyword) => {
   const k = (keyword || '').trim()
   if (!k) {
     customerSearchResults.value = []
     customerSearchError.value = ''
     return
   }

   if (k === lastCustomerKeyword.value) return
   lastCustomerKeyword.value = k

   customerSearchLoading.value = true
   customerSearchError.value = ''

   try {
@@ -1744,84 +1772,98 @@ const savePayment = async () => {

   const contractIndex = contracts.value.findIndex(c => c.id === currentContract.value.id)
   if (contractIndex === -1) return

   const payload = {
     hopDongId: currentContract.value.id,
     soTienDong: payment.value.amount,
     hinhThucThanhToan: payment.value.method,
     ngayDongTien: payment.value.date || todayISO(),
     ghiChu: payment.value.note
   }

   try {
     await showLoading(api.post('/hop-dong/admin/dong-phi', payload))
     updateAlertSuccess('ƒê√≥ng ph√≠ th√†nh c√¥ng', `+${formatMoney(payment.value.amount)} (${payment.value.method})`)
     await fetchContracts()
     closeModal('modalPay')
   } catch (error) {
     console.error('‚ùå L·ªói ƒë√≥ng ph√≠', error)
     updateAlertError('ƒê√≥ng ph√≠ th·∫•t b·∫°i', 'Vui l√≤ng th·ª≠ l·∫°i sau.')
   }
 }

 // Refund management
 const openRefund = (contract) => {
+  const maxRefund = getMaxRefundAmount(contract)
+  if (maxRefund <= 0) {
+    showCenterWarning('Ch∆∞a c√≥ ph√≠ ƒë√£ thu', 'Kh√¥ng th·ªÉ ho√†n ph√≠ khi h·ª£p ƒë·ªìng ch∆∞a thu ti·ªÅn.')
+    return
+  }
   currentContract.value = contract
   refund.value = {
     amount: 0,
     date: todayISO(),
     reason: ''
   }
   openModal('modalRefund')
 }

-const saveRefund = () => {
+const saveRefund = async () => {
   if (refund.value.amount <= 0) {
-    showToastMessage('error', 'S·ªë ti·ªÅn kh√¥ng h·ª£p l·ªá', 'S·ªë ti·ªÅn ho√†n ph·∫£i > 0.')
+    showCenterWarning('S·ªë ti·ªÅn kh√¥ng h·ª£p l·ªá', 'S·ªë ti·ªÅn ho√†n ph·∫£i > 0.')
     return
   }

-  if (!refund.value.reason) {
-    showToastMessage('error', 'Thi·∫øu l√Ω do', 'B·∫°n c·∫ßn nh·∫≠p l√Ω do ho√†n.')
+  const reason = (refund.value.reason || '').trim()
+  if (reason.length < 10) {
+    showCenterWarning('Thi·∫øu l√Ω do', 'L√Ω do ho√†n t·ªëi thi·ªÉu 10 k√Ω t·ª±.')
     return
   }

-  const contractIndex = contracts.value.findIndex(c => c.id === currentContract.value.id)
-  if (contractIndex === -1) return
+  const maxRefund = getMaxRefundAmount(currentContract.value)
+  if (refund.value.amount > maxRefund) {
+    showCenterWarning('S·ªë ti·ªÅn v∆∞·ª£t qu√° ƒë√£ thu', `T·ªëi ƒëa ƒë√£ thu: ${formatMoney(maxRefund)}.`)
+    return
+  }

-  contracts.value[contractIndex].hoanTien.push({
-    id: crypto.randomUUID(),
+  const payload = {
+    hopDongId: currentContract.value.id,
     soTienHoan: refund.value.amount,
-    lyDoHoan: refund.value.reason,
     ngayHoan: refund.value.date || todayISO(),
-    nguoiDuyet: 'demo_ke_toan',
-    ngayTao: new Date().toLocaleString('vi-VN')
-  })
+    lyDoHoan: reason
+  }

-  showToastMessage('success', 'Ho√†n ph√≠ th√†nh c√¥ng', `-${formatMoney(refund.value.amount)}`)
-  closeModal('modalRefund')
+  try {
+    await showLoading(api.post('/hop-dong/admin/hoan-phi', payload))
+    updateAlertSuccess('Ho√†n ph√≠ th√†nh c√¥ng', `-${formatMoney(refund.value.amount)}`)
+    await fetchContracts()
+    closeModal('modalRefund')
+  } catch (error) {
+    console.error('‚ùå L·ªói ho√†n ph√≠', error)
+    updateAlertError('Ho√†n ph√≠ th·∫•t b·∫°i', 'Vui l√≤ng th·ª≠ l·∫°i sau.')
+  }
 }

 // Adjustment management
 const openAdjust = (contract) => {
   currentContract.value = contract
   adjustment.value = {
     amount: 0,
     type: 'GIAM_GIA',
     reason: ''
   }
   openModal('modalAdjust')
 }

 const saveAdjustment = () => {
   if (adjustment.value.amount === 0) {
     showToastMessage('error', 'S·ªë ti·ªÅn kh√¥ng h·ª£p l·ªá', 'ƒêi·ªÅu ch·ªânh ph·∫£i kh√°c 0 (√¢m ho·∫∑c d∆∞∆°ng).')
     return
   }

   if (!ENUM_ADJ.includes(adjustment.value.type)) {
     showToastMessage('error', 'Lo·∫°i ƒëi·ªÅu ch·ªânh sai', 'Ch·ªçn GIAM_GIA/PHU_THU/PHAT.')
     return
   }

   if (!adjustment.value.reason) {
