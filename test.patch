diff --git a/src/components/dich-vu/Phi-dich-vu.vue b/src/components/dich-vu/Phi-dich-vu.vue
index 9f844374e0e9244bc96ca9a1e5e3e0560c6477ff..f70769ca1c7f9af72b7261bf2eacaf2838310d91 100644
--- a/src/components/dich-vu/Phi-dich-vu.vue
+++ b/src/components/dich-vu/Phi-dich-vu.vue
@@ -1233,50 +1233,51 @@ const canDeleteContract = computed(() => authStore.hasPermission('HOPDONG_DELETE
 const canCancelContract = computed(() => authStore.hasPermission('HOPDONG_HUY'))
 const canContractSetting = computed(() => authStore.hasPermission('HOPDONG_SETTING'))
 const canFullBranch = computed(() => authStore.hasPermission('HOPDONG_FULL_CHINHANH'))
 const todayISO = () => {
   const d = new Date()
   const yyyy = d.getFullYear()
   const mm = String(d.getMonth() + 1).padStart(2, '0')
   const dd = String(d.getDate()).padStart(2, '0')
   return `${yyyy}-${mm}-${dd}`
 }
 // Constants
 const ENUM_STATUS = ['DANG_HIEU_LUC', 'HOAN_TAT', 'HUY']
 const ENUM_PAY = ['TIEN_MAT', 'CHUYEN_KHOAN', 'QR', 'KHAC']
 const ENUM_ADJ = ['GIAM_GIA', 'PHU_THU', 'PHAT', 'CHUYEN_DOI_DV']

 // State
 const activeTab = ref(1)
 const contracts = ref([])
 const totalElements = ref(0)
 const totalPages = ref(1)
 const seq = ref(1)
 const services = ref([])
 const segments = ref([])
 const branchOptions = ref([])
 const branchLoading = ref(false)
+const draftBranchId = ref(null)

 // Filters
 const searchQuery = ref('')
 const filterService = ref(null)
 const filterBranch = ref(null)
 const filterStatus = ref(null)
 const tuNgay = ref(null)
 const denNgay = ref(null)
 const currentPage = ref(1)
 const pageSize = ref(10)
 const currentUserName = ref('Nguy·ªÖn Minh')
 const searchTimer = ref(null)

 // Customer search
 const customerSearch = ref('')
 const selectedCustomer = ref(null)
 const customerSearchResults = ref([])
 const customerSearchLoading = ref(false)
 const customerSearchError = ref('')
 const customerSearchTimer = ref(null)
 const lastCustomerKeyword = ref('')
 const suppressCustomerSearch = ref(false)
 const CONTRACT_DRAFT_KEY = 'contractDraftFromAppointment'

 // New contract form
@@ -1374,50 +1375,72 @@ const totalDoanhSo = computed(() => {
 const serviceOptions = computed(() => {
   return services.value
 })

 const branchFilterOptions = computed(() => ([
   { id: null, label: 'T·∫•t c·∫£' },
   ...branchOptions.value
 ]))

 const selectedService = computed(() => {
   if (!newContract.value.serviceId) return null
   return serviceOptions.value.find(s => String(s.id || s.name) === String(newContract.value.serviceId)) || null
 })

 const matchingSegment = computed(() => {
   const serviceId = newContract.value.serviceId
   const assetValue = Number(newContract.value.giaTriTaiSan || 0)
   if (!serviceId || assetValue <= 0) return null
   return segments.value.find(seg =>
       String(seg.serviceId) === String(serviceId) &&
       assetValue >= Number(seg.min) &&
       assetValue < Number(seg.max)
   ) || null
 })

+const getDefaultBranchId = () => {
+  if (canFullBranch.value) {
+    const hasDraftMatch = draftBranchId.value && branchOptions.value.some(
+      (branch) => String(branch.id) === String(draftBranchId.value)
+    )
+    if (hasDraftMatch) return draftBranchId.value
+    return branchOptions.value[0]?.id ?? null
+  }
+  return draftBranchId.value ?? null
+}
+
+const resolveBranchId = () => {
+  if (canFullBranch.value) {
+    const preferred = draftBranchId.value ?? newContract.value.branchId
+    const hasPreferred = preferred && branchOptions.value.some(
+      (branch) => String(branch.id) === String(preferred)
+    )
+    return hasPreferred ? preferred : branchOptions.value[0]?.id ?? null
+  }
+  return draftBranchId.value ?? null
+}
+
 const segmentHint = computed(() => {
   if (!newContract.value.serviceId) {
     return 'Vui l√≤ng ch·ªçn d·ªãch v·ª• ƒë·ªÉ hi·ªÉn th·ªã ph√¢n kh√∫c.'
   }
   if (!newContract.value.giaTriTaiSan) {
     return 'Nh·∫≠p gi√° tr·ªã t√†i s·∫£n ƒë·ªÉ x√°c ƒë·ªãnh m·ª©c gi√° g·ªëc.'
   }
   if (!matchingSegment.value) {
     return 'Ch∆∞a c√≥ ph√¢n kh√∫c ph√π h·ª£p v·ªõi gi√° tr·ªã t√†i s·∫£n n√†y.'
   }
   return `Ph√¢n kh√∫c ${formatMoney(matchingSegment.value.min)} ‚Üí ${formatMoney(matchingSegment.value.max)}`
 })

 const firstPaymentAmount = computed(() => {
   if (newContract.value.initPlan === 'FULL') {
     return newContract.value.giaSauGiam
   } else {
     const percent = Math.max(0, Math.min(100, newContract.value.tiLeCoc || 0))
     return Math.round(newContract.value.giaSauGiam * (percent / 100))
   }
 })

 const adjustmentFirstPaymentAmount = computed(() => {
   if (adjustment.value.initPlan === 'FULL') {
     return adjustment.value.giaSauGiam
@@ -1504,75 +1527,68 @@ watch(() => newContract.value.giaTriTaiSan, () => {
 watch(() => newContract.value.discountMode, () => {
   updateGiaSauGiam()
 })

 watch(() => adjustment.value.serviceId, () => {
   updateAdjustmentServicePrice()
 })

 watch(() => adjustment.value.giaTriTaiSan, () => {
   updateAdjustmentGiaGocFromAsset()
 })

 watch(() => adjustment.value.discountMode, () => {
   updateAdjustmentGiaSauGiam()
 })
 const fetchBranchOptions = async () => {
   if (branchLoading.value) return
   branchLoading.value = true
   try {
     const res = await api.get('/customer-crm/admin/lich-hen/options')
     branchOptions.value = (Array.isArray(res.data) ? res.data : []).map((branch) => ({
       id: Number(branch.id),
       label: branch.address
     }))
     if (canFullBranch.value && branchOptions.value.length > 0) {
-      const hasMatch = branchOptions.value.some(
-          (branch) => String(branch.id) === String(newContract.value.branchId)
-      )
-      if (!hasMatch) {
-        newContract.value.branchId = branchOptions.value[0].id ?? null
-      }
+      newContract.value.branchId = resolveBranchId()
     }
   } catch (e) {
     console.error('‚ùå L·ªói fetch branches', e)
     branchOptions.value = []
   } finally {
     branchLoading.value = false
   }
 }
 watch(
   canFullBranch,
   (value) => {
     if (value) {
       fetchBranchOptions()
-      if (!newContract.value.branchId && branchOptions.value.length) {
-        newContract.value.branchId = branchOptions.value[0].id ?? null
-      }
+      newContract.value.branchId = resolveBranchId()
       return
     }
-    newContract.value.branchId = null
+    newContract.value.branchId = resolveBranchId()
   },
   { immediate: true }
 )

 watch(() => payment.value.amount, (val) => {
   if (!currentContract.value) return

   const maxAmount = calcConThieu(currentContract.value)

   // üîë Parse ‚Üí √âP S·ªê NGUY√äN
   let num = Math.floor(parseNumberInput(val))

   if (num > maxAmount) num = maxAmount
   if (num < 0) num = 0

   if (num !== payment.value.amount) {
     payment.value.amount = num
   }
 })

 watch(() => refund.value.amount, (val) => {
   if (!currentContract.value) return

   const maxAmount = getMaxRefundAmount(currentContract.value)
   let num = Math.floor(parseNumberInput(val))
@@ -1812,50 +1828,55 @@ const getServiceById = (serviceId) => {
 }

 const applyContractDraftFromAppointment = async () => {
   const raw = localStorage.getItem(CONTRACT_DRAFT_KEY)
   if (!raw) return
   localStorage.removeItem(CONTRACT_DRAFT_KEY)

   let draft = null
   try {
     draft = JSON.parse(raw)
   } catch (e) {
     return
   }

   if (!draft?.phone && !draft?.serviceId) return

   resetContractForm()

   if (draft?.serviceId) {
     const matchedService = getServiceById(draft.serviceId)
     if (matchedService) {
       newContract.value.serviceId = matchedService.id || matchedService.name
     }
   }

+  if (draft?.branchId !== undefined && draft?.branchId !== null) {
+    draftBranchId.value = draft.branchId
+    newContract.value.branchId = resolveBranchId()
+  }
+
   openModal('modalContract')
   updateServicePrice()

   const phone = String(draft?.phone || '').trim()
   if (!phone) return

   suppressCustomerSearch.value = true
   customerSearch.value = phone
   suppressCustomerSearch.value = false

   await fetchCustomerSearch(phone)
   const matchedCustomer = customerSearchResults.value.find(
     (customer) => String(customer.phone || customer.raw?.phone || '') === phone
   )
   if (matchedCustomer) {
     selectCustomer(matchedCustomer)
   } else if (customerSearchResults.value.length === 1) {
     selectCustomer(customerSearchResults.value[0])
   }
 }

 const getSegmentsByService = (serviceId) => {
   return segments.value
       .filter(seg => String(seg.serviceId) === String(serviceId))
       .sort((a, b) => Number(a.min) - Number(b.min))
@@ -1910,57 +1931,58 @@ const calcConThieu = (c) => {
   return getConThieu(c)
 }

 const getMaxRefundAmount = (c) => {
   return Math.max(0, getDoanhThuRow(c))
 }

 // Modal control
 const openModal = (modal) => {
   showModal.value = modal
 }

 const closeModal = (modal) => {
   resetContractForm()
   if (showModal.value === modal) {
     showModal.value = null
   }
   if (modal === 'modalDetail') {
     detailContract.value = null
   }
 }

 // Contract management
 const resetContractForm = () => {
   const firstService = serviceOptions.value[0] || null
+  draftBranchId.value = null
   newContract.value = {
     maHopDong: genContractCode(),
     maKhachHang: '',
     tenKhachHang: '',
     tenDichVu: firstService?.name || '',
     serviceId: firstService?.id || firstService?.name || null,
-    branchId: canFullBranch.value ? branchOptions.value[0]?.id ?? null : null,
+    branchId: getDefaultBranchId(),
     giaTriTaiSan: null,
     giaDichVuGoc: 0,
     phiGiam: 0,
     discountMode: 'PERCENT',
     discountValue: 0,
     giaSauGiam: 0,
     trangThaiHopDong: 'DANG_HIEU_LUC',
     ngayKy: todayISO(),
     initPlan: 'COC',
     tiLeCoc: 30,
     firstMethod: 'CHUYEN_KHOAN'
   }
   customerSearch.value = ''
   selectedCustomer.value = null
   customerSearchResults.value = []
   customerSearchError.value = ''
   customerSearchLoading.value = false
   updateServicePrice()
 }

 const updateServicePrice = () => {
   const service = getServiceById(newContract.value.serviceId)
   newContract.value.tenDichVu = service?.name || ''
   updateGiaGocFromAsset()
 }
@@ -2137,51 +2159,51 @@ const saveContract = async () => {
   }

   if (!newContract.value.giaTriTaiSan) {
     showError('Thi·∫øu d·ªØ li·ªáu', 'B·∫°n c·∫ßn nh·∫≠p gi√° tr·ªã t√†i s·∫£n.')
     return
   }

   if (!newContract.value.giaDichVuGoc) {
     showError('Thi·∫øu d·ªØ li·ªáu', 'Gi√° g·ªëc ch∆∞a x√°c ƒë·ªãnh theo ph√¢n kh√∫c.')
     return
   }

   if (newContract.value.discountMode === 'MONEY' && newContract.value.discountValue <= 0) {
     showError('Gi·∫£m gi√° kh√¥ng h·ª£p l·ªá', 'Gi·∫£m gi√° ti·ªÅn ph·∫£i > 0 v√† kh√¥ng v∆∞·ª£t qu√° gi√° g·ªëc.')
     return
   }

   const payload = {
     maKhachHang: newContract.value.maKhachHang,
     giaTriKyBan: newContract.value.giaTriTaiSan,
     giaDichVuGoc: newContract.value.giaDichVuGoc,
     phiGiam: newContract.value.phiGiam || 0,
     giaSauGiam: newContract.value.giaSauGiam,
     hinhThucThanhToan: newContract.value.firstMethod,
     serviceId: newContract.value.serviceId,
-    branchId: canFullBranch.value ? newContract.value.branchId : null,
+    branchId: newContract.value.branchId ?? null,
     soTienThanhToan: firstPaymentAmount.value,
     initPlan: newContract.value.initPlan
   }

   try {
     const res = await showLoading(api.post('/hop-dong/admin/create', payload))
     const created = res?.data || {}
     const hasPayments = Array.isArray(created.dotDongTien) && created.dotDongTien.length > 0
     const contract = {
       id: created.id || crypto.randomUUID(),
       maHopDong: created.maHopDong || newContract.value.maHopDong,
       maKhachHang: created.maKhachHang ?? newContract.value.maKhachHang,
       tenKhachHang: created.tenKhachHang || newContract.value.tenKhachHang,
       nhanVienTao: created.nhanVienTao || currentUserName.value,
       tenDichVu: created.tenDichVu || newContract.value.tenDichVu,
       serviceId: created.serviceId ?? newContract.value.serviceId,
       giaTriTaiSan: created.giaTriKyBan ?? created.giaTriTaiSan ?? newContract.value.giaTriTaiSan,
       giaDichVuGoc: created.giaDichVuGoc ?? newContract.value.giaDichVuGoc,
       phiGiam: created.phiGiam ?? newContract.value.phiGiam ?? 0,
       giaSauGiam: created.giaSauGiam ?? newContract.value.giaSauGiam,
       trangThaiHopDong: created.trangThaiHopDong ?? newContract.value.trangThaiHopDong,
       ngayKy: created.ngayKy ?? newContract.value.ngayKy ?? todayISO(),
       ngayTao: created.ngayTao ?? new Date().toLocaleString('vi-VN'),
       dotDongTien: hasPayments ? created.dotDongTien : [],
       hoanTien: created.hoanTien || [],
diff --git a/src/components/thiet-kegiandien/AppointmentsPage.vue b/src/components/thiet-kegiandien/AppointmentsPage.vue
index 2fa76de7ba746098bb14ed5930d2e5af1666d451..3a1547b4774d7e68800252696a429467e74faa79 100644
--- a/src/components/thiet-kegiandien/AppointmentsPage.vue
+++ b/src/components/thiet-kegiandien/AppointmentsPage.vue
@@ -1090,50 +1090,51 @@ async function saveEditModal() {

   try {
     const res = await showLoading( api.post(
         '/customer-crm/admin/lich-hen/update',
         payload
     ));

     if (res.data.success) {
       updateAlertSuccess(res?.data?.message || 'C·∫≠p nh·∫≠t l·ªãch h·∫πn th√†nh c√¥ng')
       await refreshAppointmentsAndStats()
       const temp = editForm.consultStatus;
       closeEditModal()
       // reload list / calendar n·∫øu c·∫ßn
       if ( temp === ConsultStatus.SUCCESS) {
         const shouldCreateContract = await openConfirmDialog({
           title: 'T·∫°o h·ª£p ƒë·ªìng cho kh√°ch h√†ng?',
           message: 'Bu·ªïi h·∫πn th√†nh c√¥ng. B·∫°n c√≥ mu·ªën t·∫°o h·ª£p ƒë·ªìng ngay b√¢y gi·ªù kh√¥ng?',
           confirmText: 'T·∫°o h·ª£p ƒë·ªìng',
           cancelText: 'ƒê·ªÉ sau',
           variant: 'success',
         })
         if (shouldCreateContract) {
           const payloadDraft = {
             phone: editContext.phone || null,
             serviceId: editForm.rating ?? editContext.serviceId ?? null,
+            branchId: editForm.branch ?? null,
           }
           localStorage.setItem('contractDraftFromAppointment', JSON.stringify(payloadDraft))
           window.location.assign('/-thg/quan-ly-hop-dong')
         }
       }
     } else {
       updateAlertError(res?.data?.message || 'C·∫≠p nh·∫≠t th·∫•t b·∫°i')
       await openConfirmDialog({
         title: 'C·∫≠p nh·∫≠t th·∫•t b·∫°i',
         message: res?.data?.message || 'C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i.',
         confirmText: 'ƒê√≥ng',
         showCancel: false,
         variant: 'danger',
       })
     }
   } catch (e) {
     console.error('‚ùå L·ªói g·ªçi API update l·ªãch h·∫πn', e)
   }
 }
 // ===== L·∫•y t·∫•t c·∫£ chi nh√°nh =========
 const applyServiceDefaults = () => {
   const firstServiceId = serviceOptions.value[0]?.id ?? null
   const createHasService = serviceOptions.value.some(
     (service) => String(service.id ?? service.name) === String(createForm.rating)
   )
