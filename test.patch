diff --git a/src/components/dich-vu/Phi-dich-vu.vue b/src/components/dich-vu/Phi-dich-vu.vue
index 29df8e9f231afe33222c4b3827fb57b2bad9458d..f2314c4345ea0b0c0daf28222f9305b57e0c3fb5 100644
--- a/src/components/dich-vu/Phi-dich-vu.vue
+++ b/src/components/dich-vu/Phi-dich-vu.vue
@@ -1189,50 +1189,51 @@ const totalElements = ref(0)
 const totalPages = ref(1)
 const seq = ref(1)
 const services = ref([])
 const segments = ref([])

 // Filters
 const searchQuery = ref('')
 const filterService = ref(null)
 const filterStatus = ref(null)
 const tuNgay = ref(null)
 const denNgay = ref(null)
 const currentPage = ref(1)
 const pageSize = ref(2)
 const currentUserName = ref('Nguyễn Minh')
 const searchTimer = ref(null)

 // Customer search
 const customerSearch = ref('')
 const selectedCustomer = ref(null)
 const customerSearchResults = ref([])
 const customerSearchLoading = ref(false)
 const customerSearchError = ref('')
 const customerSearchTimer = ref(null)
 const lastCustomerKeyword = ref('')
 const suppressCustomerSearch = ref(false)
+const CONTRACT_DRAFT_KEY = 'contractDraftFromAppointment'

 // New contract form
 const newContract = ref({
   maHopDong: '',
   maKhachHang: '',
   tenKhachHang: '',
   tenDichVu: '',
   serviceId: null,
   giaTriTaiSan: null,
   giaDichVuGoc: 0,
   phiGiam: 0,
   discountMode: 'PERCENT',
   discountValue: 0,
   giaSauGiam: 0,
   trangThaiHopDong: 'DANG_HIEU_LUC',
   ngayKy: todayISO(),
   initPlan: 'COC',
   tiLeCoc: 30,
   firstMethod: 'CHUYEN_KHOAN'
 })

 // Modals
 const showModal = ref(null)
 const currentContract = ref(null)
 const detailContract = ref(null)
@@ -1651,50 +1652,94 @@ const fetchContracts = async () => {
     size: pageSize.value
   }

   try {
     const res = await api.post('/hop-dong/admin/search', payload)
     const page = res?.data || {}
     const items = Array.isArray(page.content) ? page.content : []
     contracts.value = items
     totalElements.value = Number(page.page.totalElements ?? items.length)
     totalPages.value = Number(page.page.totalPages ?? Math.max(1, Math.ceil(totalElements.value / pageSize.value)))
     if (currentPage.value > totalPages.value) {
       currentPage.value = totalPages.value || 1
     }
   } catch (e) {
     console.error('❌ Lỗi fetch contracts', e)
     contracts.value = []
     totalElements.value = 0
     totalPages.value = 1
   }
 }

 const getServiceById = (serviceId) => {
   return serviceOptions.value.find(s => String(s.id || s.name) === String(serviceId)) || null
 }

+const applyContractDraftFromAppointment = async () => {
+  const raw = localStorage.getItem(CONTRACT_DRAFT_KEY)
+  if (!raw) return
+  localStorage.removeItem(CONTRACT_DRAFT_KEY)
+
+  let draft = null
+  try {
+    draft = JSON.parse(raw)
+  } catch (e) {
+    return
+  }
+
+  if (!draft?.phone && !draft?.serviceId) return
+
+  resetContractForm()
+
+  if (draft?.serviceId) {
+    const matchedService = getServiceById(draft.serviceId)
+    if (matchedService) {
+      newContract.value.serviceId = matchedService.id || matchedService.name
+    }
+  }
+
+  openModal('modalContract')
+  updateServicePrice()
+
+  const phone = String(draft?.phone || '').trim()
+  if (!phone) return
+
+  suppressCustomerSearch.value = true
+  customerSearch.value = phone
+  suppressCustomerSearch.value = false
+
+  await fetchCustomerSearch(phone)
+  const matchedCustomer = customerSearchResults.value.find(
+    (customer) => String(customer.phone || customer.raw?.phone || '') === phone
+  )
+  if (matchedCustomer) {
+    selectCustomer(matchedCustomer)
+  } else if (customerSearchResults.value.length === 1) {
+    selectCustomer(customerSearchResults.value[0])
+  }
+}
+
 const getSegmentsByService = (serviceId) => {
   return segments.value
       .filter(seg => String(seg.serviceId) === String(serviceId))
       .sort((a, b) => Number(a.min) - Number(b.min))
 }

 const findSegmentForAsset = (serviceId, assetValue) => {
   if (!serviceId || !assetValue) return null
   const segments = getSegmentsByService(serviceId)
   return segments.find(seg =>
       assetValue >= Number(seg.min) && assetValue < Number(seg.max)
   ) || null
 }

 const genContractCode = () => {
   const y = new Date().getFullYear()
   return `HD-${y}-${pad4(seq.value++)}`
 }

 // Calculation functions
 const calcTongDong = (c) => {
   return (c?.dotDongTien || []).reduce((sum, x) => sum + (Number(x.soTienDong) || 0), 0)
 }

 const calcTongHoan = (c) => {
@@ -2607,52 +2652,53 @@ const init3Samples = () => {

     // Add extra payment if HOAN_TAT and not FULL
     if (x.trangThaiHopDong === 'HOAN_TAT' && x.initPlan !== 'FULL') {
       const remain = Math.max(0, giaSau - amount)
       if (remain > 0) {
         contract.dotDongTien.push({
           id: crypto.randomUUID(),
           soTienDong: remain,
           hinhThucThanhToan: 'CHUYEN_KHOAN',
           ngayDongTien: x.ngayKy,
           ghiChu: 'Đóng nốt (mẫu)',
           nguoiGhiNhan: 'demo_admin',
           ngayTao: new Date().toLocaleString('vi-VN')
         })
       }
     }

     return contract
   })
 }

 // Lifecycle
 onMounted(async () => {
   document.addEventListener('click', handleDocumentClick)
   await Promise.all([fetchServices(), fetchSegments()])
-  await fetchContracts()
   resetContractForm()
+  await applyContractDraftFromAppointment()
+  await fetchContracts()
 })

 onUnmounted(() => {
   document.removeEventListener('click', handleDocumentClick)
 })
 </script>

 <style scoped>
 /* CSS styles from original file - với chỉnh sửa cho 5 nút thao tác */
 .ui-page{
   --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
   --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
   --success-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
   --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
   --danger-gradient: linear-gradient(135deg, #ff5858 0%, #f09819 100%);
   --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
   --dark-gradient: linear-gradient(135deg, #141e30 0%, #243b55 100%);
   --light-gradient: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);

   --primary-color: #667eea;
   --secondary-color: #f093fb;
   --success-color: #43e97b;
   --warning-color: #fa709a;
   --danger-color: #ff5858;
   --info-color: #4facfe;
diff --git a/src/components/thiet-kegiandien/AppointmentsPage.vue b/src/components/thiet-kegiandien/AppointmentsPage.vue
index ba8379e9afa46c1297314dfeb4bd4f481a7a5f31..0fdc4f47a519892e27e79b7d4f1dbce7a305f302 100644
--- a/src/components/thiet-kegiandien/AppointmentsPage.vue
+++ b/src/components/thiet-kegiandien/AppointmentsPage.vue
@@ -321,50 +321,54 @@ const historyPanelRef = ref(null)
 // ===== Create form =====
 const createForm = reactive({
   customerSearch: '',
   selectedCustomer: null,
   branch: null,
   date: '',
   time: '',
   staff: '',
   consultant: 'Tư vấn 1',
   note: '',
   rating: null,
 })

 const editForm = reactive({
   branch: null,
   date: '',
   time: '',
   consultantId: null,
   status: 'WAITING',
   rating: null,
   note: '',
   customerNote: '',
   updateReason: '',
   consultStatus: null
 })
+const editContext = reactive({
+  phone: '',
+  serviceId: null,
+})

 function makeHistory(actor, action, desc) {
   return { ts: nowISO(), actor, action, desc }
 }



 /**
  * Flags for marker rule:
  * - createdByMe => ORANGE marker
  * - inCharge => BLUE marker
  */
 const appointments = ref([])

 function getRowMarker(appt) {
   if (appt?.createdByMe) return { color: '#f97316', glow: 'rgba(253, 230, 138, 0.75)' } // ORANGE
   if (appt?.inCharge) return { color: '#2563eb', glow: 'rgba(191, 219, 254, 0.78)' } // BLUE
   return { color: '#667eea', glow: 'rgba(224, 231, 255, 0.7)' }
 }

 function monthTitle(d) {
   return `Tháng ${d.getMonth() + 1}, ${d.getFullYear()}`
 }

 // ===== Conflict =====
@@ -552,50 +556,51 @@ function mapAppointmentFromApi(dto) {
   }
 }
 const detailLoading = ref(false)
 const detailError = ref('')
 const editLoading = ref(false)
 const editError = ref('')
 function mapAppointmentDetailFromApi(dto) {
   return {
     id: dto.appointmentId,

     customerId: dto.customer?.id,
     customer: dto.customer?.name,
     phone: dto.customer?.phone,
     address: dto.customer?.address,
     oldAddress: dto.customer?.oldAress,
     customerNote: dto.customer?.customerNote,
     customerFee: dto.customer?.phi ?? null,
     customerType: dto.customer?.customerType,
     files: dto.customer?.files || [],
     giaBDS: dto.customer?.giaBDS || null,
     date: dto.appointmentDate,
     time: dto.appointmentTime,
     status: dto.status,
     consultStatus: dto.consultStatus,
     rating: dto.rating,
+    maDichVu: dto.maDichVu ?? dto.serviceId ?? dto.dichVuId ?? null,
     tenDichVu: dto.tenDichVu ?? dto.serviceName ?? dto.dichVuName ?? '',
     mauDichVu: dto.mauDichVu ?? dto.serviceColor ?? dto.dichVuColor ?? '',
     note: dto.note,
     branchId: dto.branchID ?? null,   // ✅ ID
     branch: dto.branch ?? null,

     consultantId: dto.consultant?.id ?? dto.consultantId,
     consultant: dto.consultant?.name,
     creator: dto.creator?.name,

     history: (dto.histories || []).map(h => ({
       ts: h.createdAt,
       actor: h.actorName,
       action: h.action,
       desc: h.note,
       status: h.status,
       consultStatus: h.consultStatus,
     })),
   }
 }
 async function openDetailModal(appt) {
   isDetailModalOpen.value = true
   selectedAppointment.value = null
   detailLoading.value = true
   detailError.value = ''
@@ -946,102 +951,115 @@ function syncHistoryPanelHeight() {
   const leftHeight = detailCardRef.value.offsetHeight
   if (!leftHeight) return
   historyPanelRef.value.style.height = `${leftHeight}px`
 }

 // ===== Edit modal =====
 async function openEditModal(id) {
   editId.value = id
   closeDetailModal()
   isModalOpen.value = true
   editLoading.value = true
   editError.value = ''

   try {
     const res = await api.get(`/customer-crm/admin/lich-hen/${id}`)
     const mapped = mapAppointmentDetailFromApi(res.data)
     console.log('Edit appointment data', mapped.branchId)
     editForm.branch = BRANCHES.value.find(
         b => b.key === mapped.branchId
     )?.key ?? null
     console.log('Mapped branch ID for edit form', editForm.branch)
     editForm.date = mapped.date || ''
     editForm.time = mapped.time || ''
     editForm.consultantId = mapped.consultantId || null
     editForm.status = mapped.status || 'WAITING'
-    editForm.rating = mapped.rating ?? null
+    editForm.rating = mapped.maDichVu ?? mapped.rating ?? null
     editForm.note = mapped.note || ''
     editForm.customerNote = mapped.customerNote || ''
     editForm.consultStatus = mapped.consultStatus || null
+    editContext.phone = mapped.phone || ''
+    editContext.serviceId = mapped.maDichVu ?? mapped.rating ?? null
     applyServiceDefaults()

     renderHistory(mapped)
     await fetchEditConsultantsByBranch(editForm.branch)
   } catch (e) {
     editError.value = 'Không thể tải chi tiết lịch hẹn'
     showToast('Lỗi tải lịch hẹn', 'Không thể tải chi tiết lịch hẹn.', 'error')
   } finally {
     editLoading.value = false
   }
 }
 function closeEditModal() {
   isModalOpen.value = false
   editId.value = null
   editError.value = ''
   editLoading.value = false,
   editForm.updateReason = ''
 }
 async function saveEditModal() {
   if (editId.value == null) return

   const payload = {
     appointmentId: editId.value,
     branchId: editForm.branch,
     appointmentDate: editForm.date,
     appointmentTime: editForm.time,
     consultantId: editForm.consultantId,
     status: editForm.status,
     rating: editForm.rating,
     consultStatus: editForm.consultStatus || null, // ✅ thêm
     note: editForm.note?.trim(),
     customerNote: editForm.customerNote?.trim(),
     updateReason: editForm.updateReason?.trim(),
   }

   console.log('Update appointment payload', payload)

   try {
     const res = await showLoading( api.post(
         '/customer-crm/admin/lich-hen/update',
         payload
     ));

     if (res.data.success) {
       updateAlertSuccess('✅ Cập nhật lịch hẹn thành công')
       await refreshAppointmentsAndStats()
       closeEditModal()
       // reload list / calendar nếu cần
+      if (editForm.consultStatus === ConsultStatus.SUCCESS) {
+        const shouldCreateContract = window.confirm('Buổi hẹn thành công. Tạo hợp đồng cho khách hàng?')
+        if (shouldCreateContract) {
+          const payloadDraft = {
+            phone: editContext.phone || null,
+            serviceId: editForm.rating ?? editContext.serviceId ?? null,
+          }
+          localStorage.setItem('contractDraftFromAppointment', JSON.stringify(payloadDraft))
+          window.location.assign('/-thg/dich-vu')
+        }
+      }
     } else {
       updateAlertError('❌ Cập nhật thất bại:', res.data.message)
       alert(res.data.message)
     }
   } catch (e) {
     console.error('❌ Lỗi gọi API update lịch hẹn', e)
   }
 }
 // ===== Lấy tất cả chi nhánh =========
 const applyServiceDefaults = () => {
   const firstServiceId = serviceOptions.value[0]?.id ?? null
   const createHasService = serviceOptions.value.some(
     (service) => String(service.id ?? service.name) === String(createForm.rating)
   )
   const editHasService = serviceOptions.value.some(
     (service) => String(service.id ?? service.name) === String(editForm.rating)
   )
   if ((!createForm.rating || !createHasService) && firstServiceId) {
     createForm.rating = firstServiceId
   }
   if (isModalOpen.value && (!editForm.rating || !editHasService) && firstServiceId) {
     editForm.rating = firstServiceId
   }
 }

