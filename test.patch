diff --git a/src/components/thiet-kegiandien/AppointmentsPage.vue b/src/components/thiet-kegiandien/AppointmentsPage.vue
index 45099ab3577853b7f7dd3ba45eb2eec7fd1e462f..f3796379999eb033deb8791de551d211d70fef74 100644
--- a/src/components/thiet-kegiandien/AppointmentsPage.vue
+++ b/src/components/thiet-kegiandien/AppointmentsPage.vue
@@ -1,29 +1,30 @@
 <script setup>
 import { ref, reactive, onMounted, onBeforeUnmount, nextTick, watch } from 'vue'
 import { Chart, registerables } from 'chart.js'
 import api from '/src/api/api.js'
+import FileNew from './File.vue'
 Chart.register(...registerables)

 const rootRef = ref(null)
 const cleanupHandlers = []
 let chart1 = null
 let chart2 = null
 let chart3 = null

 // ===== Stats (KHÔNG ăn theo bộ lọc) =====
 const statTotal = ref(0)
 const statSelectedDay = ref(0)
 const statUp = ref(0)
 const statPending = ref(0)

 // ===== Filter (CHỈ áp dụng cho Calendar + Day Schedule + Table) =====
 const activeFilterText = ref('Tuần này')
 const activeFilterCount = ref(0)
 const filteredAppointments = ref([])

 const daySlots = ref([])
 const dayTitle = ref('')
 const calendarTitle = ref('')
 const calendarCells = ref([])
 const historyItems = ref([])

@@ -78,71 +79,90 @@ const STATUS = {
   CANCELLED: { label: 'Huỷ', cls: 'st-cancel', dot: '#ff5858' },
 }

 const CONSULT_STATUS = {
   SUCCESS: { label: 'Thành công', cls: 'cs-ok', icon: 'fa-circle-check' },
   FAIL: { label: 'Thất bại', cls: 'cs-fail', icon: 'fa-circle-xmark' },
   CARE: { label: 'Chăm sóc', cls: 'cs-care', icon: 'fa-hand-holding-heart' },
 }
 function getConsultInfo(value) {
   // ✅ null / undefined
   if (!value) {
     return {
       label: 'Chưa có',
       cls: 'cs-none',
       icon: 'fa-circle-minus',
     }
   }

   // ✅ value không nằm trong enum
   return CONSULT_STATUS[value] || {
     label: value,
     cls: 'cs-unknown',
     icon: 'fa-circle-question',
   }
 }
+function getStatusInfo(value) {
+  return STATUS[value] || {
+    label: value || 'Chưa có',
+    cls: 'st-unknown',
+    dot: '#94a3b8',
+  }
+}

 const APPOINTMENT_ACTION = {
   CREATE: { label: 'Tạo mới', cls: 'act-create' },
   EDIT: { label: 'Chỉnh sửa', cls: 'act-edit' },
   STATUS: { label: 'Đổi trạng thái', cls: 'act-status' },
   RESCHEDULE: { label: 'Dời lịch', cls: 'act-reschedule' },
   NOTE: { label: 'Ghi chú', cls: 'act-note' },
   DELETE: { label: 'Xoá lịch', cls: 'act-delete' },
 }

 const CUSTOMER_TYPE = {
   CHINH_CHU:  { label: 'Chính chủ', cls: 'ct-owner' },
   MOI_GIOI:   { label: 'Môi giới', cls: 'ct-broker' },
   NGUOI_THAN: { label: 'Người thân', cls: 'ct-relative' },
 }
+function getCustomerTypeInfo(value) {
+  return CUSTOMER_TYPE[value] || {
+    label: value || 'Chưa có',
+    cls: 'ct-unknown',
+  }
+}


 const RATING = {
   BAN_NHANH_30N: { label: 'Bán nhanh 30 ngày', cls: 'rt-bn30' },
   BAN_GP: { label: 'Bán giải pháp', cls: 'rt-bgp' },
 }
+function getRatingInfo(value) {
+  return RATING[value] || {
+    label: value || 'Chưa có',
+    cls: 'rt-unknown',
+  }
+}

 const DAY_START_HOUR = 8
 const DAY_END_HOUR = 17
 const TIME_SLOTS = Array.from({ length: DAY_END_HOUR - DAY_START_HOUR + 1 }, (_, i) => `${pad2(DAY_START_HOUR + i)}:00`)

 function timeToMinutes(time) {
   const [h, m] = String(time || '').split(':')
   return Number(h) * 60 + Number(m)
 }

 function buildDaySlotTimes(list) {
   const times = new Set(TIME_SLOTS)
   list.forEach((a) => {
     if (!a?.time) return
     const minutes = timeToMinutes(a.time)
     if (Number.isNaN(minutes)) return
     if (minutes < DAY_START_HOUR * 60 || minutes > DAY_END_HOUR * 60) return
     times.add(a.time)
   })
   return Array.from(times).sort((a, b) => timeToMinutes(a) - timeToMinutes(b))
 }

 function formatVNDate(yyyyMMdd) {
   const [y, m, d] = yyyyMMdd.split('-')
   return `${d}/${m}/${y}`
@@ -199,50 +219,52 @@ function showToast(title, body, type = 'info') {

   const kill = () => t.remove()
   t.querySelector('.x').addEventListener('click', kill)
   setTimeout(kill, 3800)
 }

 // ===== Date =====
 const selectedDateISO = ref(getTodayISO())
 const calendarMonth = ref(new Date())

 // ===== Filter controls =====
 const activeRange = ref('week') // today | week | month
 const activeStatus = ref('ALL')
 const searchQuery = ref('')
 const searchKeyword = ref('')
 const appointmentsLoading = ref(false)
 const appointmentsError = ref('')
 let searchTimer = null

 // ===== Modals =====
 const editId = ref(null)
 const isModalOpen = ref(false)
 const isCreateModalOpen = ref(false)
 const isDetailModalOpen = ref(false)
 const selectedAppointment = ref(null)
+const detailCardRef = ref(null)
+const historyPanelRef = ref(null)

 // ===== Create form =====
 const createForm = reactive({
   customerSearch: '',
   selectedCustomer: null,
   branch: null,
   date: '',
   time: '',
   staff: '',
   consultant: 'Tư vấn 1',
   note: '',
   rating: 'BAN_NHANH_30N'
 })

 const editForm = reactive({
   customer: '',
   phone: '',
   branch: 'CN_Q1',
   date: '',
   time: '',
   staff: '',
   consultant: '',
   status: 'UP',
   consultStatus: 'CARE',
   customerType: 'OWNER',
@@ -438,87 +460,93 @@ function mapAppointmentFromApi(dto) {
     date: dto.appointmentDate,
     time: dto.appointmentTime,
     staffId: dto.staffId,
     staff: dto.staffName,
     consultantId: dto.consultantId,
     consultant: dto.consultantName,
     creatorId: dto.creatorId,
     creator: dto.creatorName,
     status: dto.status,
     consultStatus: dto.consultStatus,
     rating: dto.rating,
     createdByMe: dto.createdByMe,
     inCharge: dto.inCharge,
     branch: dto.branch || '',
     customerType: dto.customerType || null,
     note: dto.note || '',
     history: dto.history || [],
   }
 }
 const detailLoading = ref(false)
 const detailError = ref('')
 function mapAppointmentDetailFromApi(dto) {
   return {
     id: dto.appointmentId,

+    customerId: dto.customer?.id,
     customer: dto.customer?.name,
     phone: dto.customer?.phone,
     address: dto.customer?.address,
+    oldAddress: dto.customer?.oldAress,
     customerNote: dto.customer?.customerNote,
     customerType: dto.customer?.customerType,
     files: dto.customer?.files || [],

     date: dto.appointmentDate,
     time: dto.appointmentTime,
     status: dto.status,
     consultStatus: dto.consultStatus,
     rating: dto.rating,
     note: dto.note,
     branch: dto.branch,

     consultant: dto.consultant?.name,
     creator: dto.creator?.name,

     history: (dto.histories || []).map(h => ({
       ts: h.createdAt,
       actor: h.actorName,
       action: h.action,
       desc: h.note,
+      status: h.status,
+      consultStatus: h.consultStatus,
     })),
   }
 }
 async function openDetailModal(appt) {
   isDetailModalOpen.value = true
   selectedAppointment.value = null
   detailLoading.value = true
   detailError.value = ''

   try {
     const res = await api.get(`/customer-crm/admin/lich-hen/${appt.id}`)
     const mapped = mapAppointmentDetailFromApi(res.data)
     selectedAppointment.value = mapped
     renderHistory(mapped)
+    await nextTick()
+    syncHistoryPanelHeight()
   } catch (e) {
     detailError.value = 'Không thể tải chi tiết lịch hẹn'
   } finally {
     detailLoading.value = false
   }
 }

 async function fetchAppointments() {
   if (appointmentsLoading.value) return

   const { startDate, endDate } = getFilterRange()
   const payload = {
     startDate,
     endDate,
     status: activeStatus.value === 'ALL' ? null : activeStatus.value,
     search: searchKeyword.value ? searchKeyword.value.trim() : null,
   }

   appointmentsLoading.value = true
   appointmentsError.value = ''

   try {
     const res = await api.post('/customer-crm/admin/lich-hen/filter', payload)
     const data = Array.isArray(res.data) ? res.data : []
     appointments.value = data.map(mapAppointmentFromApi)
@@ -840,50 +868,57 @@ async function openCreateModal() {
 }

 function closeCreateModal() {
   isCreateModalOpen.value = false
   createForm.selectedCustomer = null
   createForm.customerSearch = ''
 }

 // ===== History =====
 function renderHistory(appt) {
   const history = (appt.history || []).slice(0, 120)
   historyItems.value = history.map((h) => {
     const dt = new Date(h.ts)
     const stamp = `${pad2(dt.getHours())}:${pad2(dt.getMinutes())} • ${pad2(dt.getDate())}/${pad2(dt.getMonth() + 1)}/${dt.getFullYear()}`
     const actionInfo = getActionInfo(h.action)
     return { ...h, stamp, actionLabel: actionInfo.label, actionClass: actionInfo.cls }
   })
 }

 // ===== Detail modal =====
 function closeDetailModal() {
   isDetailModalOpen.value = false
   selectedAppointment.value = null
 }

+function syncHistoryPanelHeight() {
+  if (!detailCardRef.value || !historyPanelRef.value) return
+  const leftHeight = detailCardRef.value.offsetHeight
+  if (!leftHeight) return
+  historyPanelRef.value.style.height = `${leftHeight}px`
+}
+
 // ===== Edit modal =====
 function openEditModal(id) {
   const appt = appointments.value.find((x) => x.id === id)
   if (!appt) return

   editId.value = id

   editForm.customer = appt.customer || ''
   editForm.phone = appt.phone || ''
   editForm.branch = appt.branch || 'CN_Q1'
   editForm.date = appt.date
   editForm.time = appt.time
   editForm.staff = appt.staff
   editForm.consultant = appt.consultant
   editForm.status = appt.status
   editForm.consultStatus = appt.consultStatus || 'CARE'
   editForm.customerType = appt.customerType || 'OWNER'
   editForm.rating = appt.rating || 'BAN_NHANH_30N'
   editForm.note = appt.note || ''

   renderHistory(appt)
   isModalOpen.value = true
 }
 function closeEditModal() {
   isModalOpen.value = false
@@ -963,50 +998,54 @@ async function fetchBranchOptions() {
   if (branchLoading.value) return

   branchLoading.value = true
   try {
     const res = await api.get('/customer-crm/admin/lich-hen/options')

     // BE trả: [{ id, address }]
     BRANCHES.value = (Array.isArray(res.data) ? res.data : []).map(b => ({
       key: Number(b.id),      // đảm bảo là number
       label: b.address,
     }))

     // ✅ AUTO SELECT CHI NHÁNH ĐẦU TIÊN
     if (!createForm.branch && BRANCHES.value.length > 0) {
       createForm.branch = BRANCHES.value[0].key
       createForm.staff = getStaffOptionsByBranch(createForm.branch)[0] || ''
     }

   } catch (e) {
     showToast('Lỗi tải chi nhánh', 'Không thể tải danh sách chi nhánh.', 'error')
     BRANCHES.value = []
   } finally {
     branchLoading.value = false
   }
 }
+function getBranchLabel(branchKey) {
+  if (!branchKey) return '-'
+  return BRANCHES.value.find((b) => b.key === branchKey)?.label || branchKey
+}
 // ======= Lấy nhân viên theo chi nhánh =======
 // ===== Consultants for CREATE modal =====
 const CREATE_CONSULTANTS = ref([])
 const createConsultantsLoading = ref(false)
 async function fetchCreateConsultantsByBranch(branchId) {
   if (!branchId) {
     CREATE_CONSULTANTS.value = []
     createForm.consultant = null
     return
   }

   createConsultantsLoading.value = true
   try {
     const res = await api.get('/customer-crm/admin/lich-hen/consultants', {
       params: { branchId },
     })

     CREATE_CONSULTANTS.value = Array.isArray(res.data) ? res.data : []

     // ✅ AUTO CHỌN NGƯỜI ĐẦU TIÊN
     createForm.consultant = CREATE_CONSULTANTS.value[0]?.id || null
   } catch (e) {
     CREATE_CONSULTANTS.value = []
     createForm.consultant = null
     showToast('Lỗi tải NV tư vấn', 'Không thể tải danh sách nhân viên tư vấn.', 'error')
@@ -1361,95 +1400,92 @@ function initCharts() {
           bodyColor: '#e8edf6',
         },
       },
     },
   })
 }

 // ===== Action menu =====
 function toggleActionMenu(id) {
   openActionMenuId.value = openActionMenuId.value === id ? null : id
 }
 function handleAction(type, appt, event) {
   openActionMenuId.value = null
   if (type === 'edit') openEditModal(appt.id)
   else if (type === 'status') openStatusPopover(event.currentTarget, appt.id)
   else if (type === 'delete') {
     appointments.value = appointments.value.filter((x) => x.id !== appt.id)
     generateCalendar()
     updateDaySchedule()
     updateFilterOutputs()
     updateGlobalStats()
     showToast('Đã xoá lịch hẹn', appt.customer || 'Đã xoá.', 'success')
   } else if (type === 'detail') openDetailModal(appt)
 }

-// ===== Helpers =====
-function getStatusInfo(status) {
-  return STATUS[status]
-}
-function getCustomerTypeInfo(value) {
-  return CUSTOMER_TYPE[value] || Object.values(CUSTOMER_TYPE)[0]
-}
-function getRatingInfo(value) {
-  return RATING[value] || Object.values(RATING)[0]
-}
-
 // ===== Watchers =====
 watch(
     () => [activeRange.value, activeStatus.value],
     () => {
       // đổi range:
       // - today/week: khoá month nav, giữ selectedDate nằm trong range
       if (activeRange.value === 'month') {
         const d = new Date(`${selectedDateISO.value}T00:00:00`)
         calendarMonth.value = new Date(d.getFullYear(), d.getMonth(), 1)
       } else {
         // đảm bảo selected date enable
         if (!isCellEnabled(selectedDateISO.value)) {
           // kéo về start tuần / today
           if (activeRange.value === 'today') selectedDateISO.value = getTodayISO()
           if (activeRange.value === 'week') selectedDateISO.value = toISODate(startOfWeek(new Date(`${selectedDateISO.value}T00:00:00`)))
         }
       }

       generateCalendar()
       updateDaySchedule()
       updateFilterOutputs()
     },
 )

 watch(
     () => searchQuery.value,
     (val) => {
       if (searchTimer) clearTimeout(searchTimer)
       searchTimer = setTimeout(() => {
         searchKeyword.value = (val || '').trim()
       }, 300)
     },
 )

+watch(
+    () => [selectedAppointment.value, historyItems.value.length],
+    async () => {
+      await nextTick()
+      syncHistoryPanelHeight()
+    },
+)
+
 watch(
     () => {
       const { startDate, endDate } = getFilterRange()
       return [startDate, endDate, activeStatus.value, searchKeyword.value].join('|')
     },
     () => {
       fetchAppointments()
     },
 )
 async function autoPickCustomerByPhone(phone) {
   // gán vào input tìm kiếm
   createForm.customerSearch = phone

   // gọi search
   await fetchCustomerSearch(phone)

   // đợi DOM + data
   await nextTick()

   // auto chọn khách đầu tiên (SĐT unique)
   if (customerSearchResults.value.length > 0) {
     selectCustomer(customerSearchResults.value[0])
   }


@@ -1486,50 +1522,51 @@ onMounted(async () => {
   // ===== Init data =====
   await fetchAppointments()

   // ===== Init charts =====
   await nextTick()
   initCharts()

   // ===== Fetch branch options (ONLY ONCE) =====


   // ===== Ready toast =====
   showToast('Sẵn sàng', 'Hệ thống quản lý lịch hẹn đã sẵn sàng.', 'success')

   // ===== Global listeners =====
   registerWindowListener('keydown', (e) => {
     if (e.key === 'Escape' && (isModalOpen.value || isCreateModalOpen.value || isDetailModalOpen.value)) {
       if (isModalOpen.value) closeEditModal()
       if (isCreateModalOpen.value) closeCreateModal()
       if (isDetailModalOpen.value) closeDetailModal()
     }
   })

   registerWindowListener('resize', async () => {
     await nextTick()
     initCharts()
+    syncHistoryPanelHeight()
   })



 })


 onBeforeUnmount(() => {
   destroyCharts()
   cleanupHandlers.forEach((cleanup) => cleanup())
 })
 </script>

 <template>
   <div ref="rootRef" class="appointments-page">
     <div class="toast-wrap" id="toastWrap"></div>

     <main class="main-content">
       <div class="header">
         <div class="page-title">
           <h2><i class="fa-solid fa-calendar-check me-2"></i>Quản lý lịch hẹn</h2>
           <p>Tạo, theo dõi và cập nhật trạng thái • phân loại • đánh giá</p>
         </div>
       </div>

@@ -2301,205 +2338,259 @@ onBeforeUnmount(() => {
                 <div v-for="item in historyItems" :key="item.ts" class="h-item">
                   <div class="h-top">
                     <span>
                       {{ item.actor }} •
                       <span class="action-pill" :class="item.actionClass">{{ item.actionLabel }}</span>
                     </span>
                     <span>{{ item.stamp }}</span>
                   </div>
                   <div class="h-desc">{{ item.desc || '' }}</div>
                 </div>
               </div>
             </div>
           </div>
         </div>

         <div class="modal-foot">
           <button class="btn btn-secondary" type="button" @click="closeEditModal">Đóng</button>
           <button class="btn btn-primary" type="button" @click="saveEditModal">
             <i class="fa-solid fa-floppy-disk"></i>Lưu thay đổi
           </button>
         </div>
       </div>
     </div>

     <!-- Modal chi tiết (màu mới đẹp hơn + icon nhỏ chung label) -->
-    <div v-if="isDetailModalOpen && selectedAppointment" class="backdrop" @click.self="closeDetailModal">
+    <div v-if="isDetailModalOpen" class="backdrop" @click.self="closeDetailModal">
       <div class="editor-modal detail" role="dialog" aria-modal="true">
         <div class="modal-head">
           <div class="mh-left">
             <div class="mh-ico"><i class="fa-regular fa-eye"></i></div>
             <div>
               <h4>Chi tiết lịch hẹn</h4>
               <p class="mh-sub">Màu sáng • card pastel • dễ đọc</p>
             </div>
           </div>
           <button class="modal-close" type="button" @click="closeDetailModal">
             <i class="fa-solid fa-xmark"></i>
           </button>
         </div>

         <div class="modal-body grid">
-          <div class="modal-card detail-card">
-            <div class="card-cap">
-              <i class="fa-solid fa-id-card"></i>
-              <span>Thông tin lịch hẹn</span>
-            </div>
-
-            <div class="detail-grid">
-              <div class="d-item">
-                <div class="d-ico di1"><i class="fa-solid fa-user"></i></div>
-                <div class="d-main">
-                  <div class="d-label">Khách hàng</div>
-                  <div class="d-value">{{ selectedAppointment.customer }}</div>
-                </div>
-              </div>
-
-              <div class="d-item">
-                <div class="d-ico di2"><i class="fa-solid fa-phone"></i></div>
-                <div class="d-main">
-                  <div class="d-label">Số điện thoại</div>
-                  <div class="d-value">{{ selectedAppointment.phone || 'Chưa có' }}</div>
-                </div>
+          <div v-if="detailLoading" class="detail-state">
+            <i class="fa-solid fa-spinner fa-spin"></i>
+            Đang tải dữ liệu...
+          </div>
+          <div v-else-if="detailError" class="detail-state error">
+            <i class="fa-solid fa-triangle-exclamation"></i>
+            {{ detailError }}
+          </div>
+          <div v-else-if="!selectedAppointment" class="detail-state error">
+            <i class="fa-solid fa-circle-xmark"></i>
+            Không có dữ liệu chi tiết.
+          </div>
+          <template v-else>
+            <div ref="detailCardRef" class="modal-card detail-card">
+              <div class="card-cap">
+                <i class="fa-solid fa-id-card"></i>
+                <span>Chi tiết lịch hẹn</span>
               </div>

-              <div class="d-item">
-                <div class="d-ico di3"><i class="fa-solid fa-building"></i></div>
-                <div class="d-main">
-                  <div class="d-label">Chi nhánh</div>
-                  <div class="d-value">{{ selectedAppointment.branch }}</div>
+              <div class="detail-section">
+                <div class="section-head">
+                  <span class="section-ico si-appointment"><i class="fa-regular fa-calendar-check"></i></span>
+                  <h5>Thông tin lịch hẹn</h5>
                 </div>
-              </div>
-
-              <div class="d-item">
-                <div class="d-ico di4"><i class="fa-regular fa-calendar"></i></div>
-                <div class="d-main">
-                  <div class="d-label">Ngày & Giờ</div>
-                  <div class="d-value">{{ formatVNDate(selectedAppointment.date) }} • {{ selectedAppointment.time }}</div>
+                <div class="section-divider"></div>
+                <div class="section-grid">
+                  <div class="field-row">
+                    <div class="field-label">Ngày & Giờ</div>
+                    <div class="field-value">{{ formatVNDate(selectedAppointment.date) }} • {{ selectedAppointment.time }}</div>
+                  </div>
+                  <div class="field-row">
+                    <div class="field-label">Trạng thái</div>
+                    <div class="field-value">
+                      <span class="status-badge" :class="getStatusInfo(selectedAppointment.status).cls">
+                        {{ getStatusInfo(selectedAppointment.status).label }}
+                      </span>
+                    </div>
+                  </div>
+                  <div class="field-row">
+                    <div class="field-label">KQ tư vấn</div>
+                    <div class="field-value">
+                      <span class="consult-badge" :class="getConsultInfo(selectedAppointment.consultStatus).cls">
+                        <i class="fa-solid" :class="getConsultInfo(selectedAppointment.consultStatus).icon"></i>
+                        {{ getConsultInfo(selectedAppointment.consultStatus).label }}
+                      </span>
+                    </div>
+                  </div>
+                  <div class="field-row">
+                    <div class="field-label">Loại dịch vụ</div>
+                    <div class="field-value">
+                      <span class="chip" :class="getRatingInfo(selectedAppointment.rating).cls">
+                        {{ getRatingInfo(selectedAppointment.rating).label }}
+                      </span>
+                    </div>
+                  </div>
+                  <div class="field-row">
+                    <div class="field-label">Chi nhánh</div>
+                    <div class="field-value">{{ getBranchLabel(selectedAppointment.branch) }}</div>
+                  </div>
                 </div>
               </div>

-              <div class="d-item">
-                <div class="d-ico di5"><i class="fa-solid fa-user-tie"></i></div>
-                <div class="d-main">
-                  <div class="d-label">NV phụ trách</div>
-                  <div class="d-value">{{ selectedAppointment.staff }}</div>
+              <div class="detail-section">
+                <div class="section-head">
+                  <span class="section-ico si-customer"><i class="fa-solid fa-user"></i></span>
+                  <h5>Thông tin khách hàng</h5>
                 </div>
-              </div>
-
-              <div class="d-item">
-                <div class="d-ico di6"><i class="fa-solid fa-circle-dot"></i></div>
-                <div class="d-main">
-                  <div class="d-label">Tình trạng</div>
-                  <div class="d-value">
-                    <span class="status-badge" :class="STATUS[selectedAppointment.status].cls">
-                      {{ STATUS[selectedAppointment.status].label }}
-                    </span>
+                <div class="section-divider"></div>
+                <div class="section-grid">
+                  <div class="field-row">
+                    <div class="field-label">Mã khách</div>
+                    <div class="field-value">{{ selectedAppointment.customerId || '-' }}</div>
                   </div>
-                </div>
-              </div>
-
-              <div class="d-item">
-                <div class="d-ico di7"><i class="fa-solid fa-bullseye"></i></div>
-                <div class="d-main">
-                  <div class="d-label">KQ tư vấn</div>
-                  <div class="d-value">
-                    <span
-                        v-if="appt && appt.consultStatus != null"
-                        class="consult-badge"
-                        :class="getConsultInfo(appt.consultStatus).cls"
-                    >
-                      <i class="fa-solid" :class="getConsultInfo(appt.consultStatus).icon"></i>
-                      {{ getConsultInfo(appt.consultStatus).label }}
-                    </span>
+                  <div class="field-row">
+                    <div class="field-label">Tên khách hàng</div>
+                    <div class="field-value">{{ selectedAppointment.customer || '-' }}</div>
+                  </div>
+                  <div class="field-row">
+                    <div class="field-label">Số điện thoại</div>
+                    <div class="field-value">{{ selectedAppointment.phone || '-' }}</div>
+                  </div>
+                  <div class="field-row">
+                    <div class="field-label">Địa chỉ hiện tại</div>
+                    <div class="field-value">{{ selectedAppointment.address || '-' }}</div>
+                  </div>
+                  <div class="field-row">
+                    <div class="field-label">Địa chỉ cũ</div>
+                    <div class="field-value">{{ selectedAppointment.oldAddress || '-' }}</div>
+                  </div>
+                  <div class="field-row">
+                    <div class="field-label">Loại khách</div>
+                    <div class="field-value">
+                      <span class="chip" :class="getCustomerTypeInfo(selectedAppointment.customerType).cls">
+                        {{ getCustomerTypeInfo(selectedAppointment.customerType).label }}
+                      </span>
+                    </div>
                   </div>
                 </div>
               </div>

-              <div class="d-item">
-                <div class="d-ico di8"><i class="fa-solid fa-tag"></i></div>
-                <div class="d-main">
-                  <div class="d-label">Phân loại</div>
-                  <div class="d-value">
-                    <span class="chip" :class="CUSTOMER_TYPE[selectedAppointment.customerType].cls">
-                      {{ CUSTOMER_TYPE[selectedAppointment.customerType].label }}
-                    </span>
+              <div class="detail-section">
+                <div class="section-head">
+                  <span class="section-ico si-note"><i class="fa-regular fa-note-sticky"></i></span>
+                  <h5>Ghi chú</h5>
+                </div>
+                <div class="section-divider"></div>
+                <div class="note-grid">
+                  <div class="note-card">
+                    <div class="note-title">Ghi chú lịch hẹn</div>
+                    <div class="note-body">{{ selectedAppointment.note || 'Không có ghi chú' }}</div>
+                  </div>
+                  <div class="note-card">
+                    <div class="note-title">Ghi chú khách</div>
+                    <div class="note-body">{{ selectedAppointment.customerNote || 'Không có ghi chú' }}</div>
                   </div>
                 </div>
               </div>

-              <div class="d-item">
-                <div class="d-ico di9"><i class="fa-solid fa-star"></i></div>
-                <div class="d-main">
-                  <div class="d-label">Loại dịch vụ</div>
-                  <div class="d-value">
-                    <span class="chip" :class="RATING[selectedAppointment.rating].cls">
-                      {{ RATING[selectedAppointment.rating].label }}
-                    </span>
+              <div class="detail-section">
+                <div class="section-head">
+                  <span class="section-ico si-staff"><i class="fa-solid fa-user-tie"></i></span>
+                  <h5>Nhân sự liên quan</h5>
+                </div>
+                <div class="section-divider"></div>
+                <div class="section-grid">
+                  <div class="field-row">
+                    <div class="field-label">Tư vấn viên</div>
+                    <div class="field-value">{{ selectedAppointment.consultant || '-' }}</div>
+                  </div>
+                  <div class="field-row">
+                    <div class="field-label">Người tạo</div>
+                    <div class="field-value">{{ selectedAppointment.creator || '-' }}</div>
                   </div>
                 </div>
               </div>

-              <div class="d-item">
-                <div class="d-ico di10"><i class="fa-solid fa-shield-halved"></i></div>
-                <div class="d-main">
-                  <div class="d-label">Người tạo</div>
-                  <div class="d-value">{{ selectedAppointment.creator }}</div>
+              <div class="detail-section">
+                <div class="section-head">
+                  <span class="section-ico si-file"><i class="fa-solid fa-paperclip"></i></span>
+                  <h5>Tệp đính kèm</h5>
+                  <span class="section-sub">({{ selectedAppointment.files.length }} tệp)</span>
+                </div>
+                <div class="section-divider"></div>
+                <div class="file-list">
+                  <div v-if="!selectedAppointment.files.length" class="muted-empty">Không có tệp đính kèm.</div>
+                  <FileNew
+                      v-else
+                      :key="'appointment-files'"
+                      :file-list="selectedAppointment.files"
+                      :entity-id="selectedAppointment.customerId"
+                      entity-type="host"
+                      :allow-download-all="true"
+                      :can-edit="false"
+                      :on-upload="false"
+                  />
                 </div>
               </div>
             </div>

-            <div class="note-box">
-              <div class="note-cap"><i class="fa-regular fa-note-sticky"></i> Ghi chú</div>
-              <div class="note-body">{{ selectedAppointment.note || 'Không có ghi chú' }}</div>
-            </div>
-          </div>
-
-          <div class="modal-panel">
-            <h5>
-              <span class="sec-ico si4"><i class="fa-solid fa-clock-rotate-left"></i></span>
-              Lịch sử thay đổi
-            </h5>
-
-            <div class="history">
-              <div v-if="!historyItems.length" class="muted-empty">Chưa có lịch sử.</div>
-              <div v-else>
-                <div v-for="item in historyItems" :key="item.ts" class="h-item">
-                  <div class="h-top">
-                    <span>
-                      {{ item.actor }} •
-                      <span class="action-pill" :class="getActionInfo(item.action).cls">
-                        {{ getActionInfo(item.action).label }}
+            <div ref="historyPanelRef" class="modal-panel">
+              <h5>
+                <span class="sec-ico si4"><i class="fa-solid fa-clock-rotate-left"></i></span>
+                Lịch sử thay đổi
+              </h5>
+
+              <div class="history">
+                <div v-if="!historyItems.length" class="muted-empty">Chưa có lịch sử.</div>
+                <div v-else>
+                  <div v-for="item in historyItems" :key="item.ts" class="h-item">
+                    <div class="h-top">
+                      <span>
+                        {{ item.actor }} •
+                        <span class="action-pill" :class="getActionInfo(item.action).cls">
+                          {{ getActionInfo(item.action).label }}
+                        </span>
                       </span>
-                    </span>
-                    <span>{{ item.stamp }}</span>
+                      <span>{{ item.stamp }}</span>
+                    </div>
+                    <div v-if="item.status || item.consultStatus" class="h-meta">
+                      <span v-if="item.status" class="status-badge" :class="getStatusInfo(item.status).cls">
+                        {{ getStatusInfo(item.status).label }}
+                      </span>
+                      <span v-if="item.consultStatus" class="consult-badge" :class="getConsultInfo(item.consultStatus).cls">
+                        <i class="fa-solid" :class="getConsultInfo(item.consultStatus).icon"></i>
+                        {{ getConsultInfo(item.consultStatus).label }}
+                      </span>
+                    </div>
+                    <div class="h-desc">{{ item.desc || '' }}</div>
                   </div>
-                  <div class="h-desc">{{ item.desc || '' }}</div>
                 </div>
               </div>
             </div>
-          </div>
+          </template>
         </div>

         <div class="modal-foot">
           <button class="btn btn-secondary" type="button" @click="closeDetailModal">Đóng</button>
           <button class="btn btn-primary" type="button" @click="openEditModal(selectedAppointment.id)">
             <i class="fa-regular fa-pen-to-square"></i>Chỉnh sửa
           </button>
         </div>
       </div>
     </div>
   </div>
 </template>

 <style scoped>
 @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');

 /* ===== Base ===== */
 .appointments-page{
   min-height:100vh;
   font-family:'Inter',sans-serif;
   color:#0f172a;
   line-height:1.6;
   background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
   zoom: 0.8;
 }
@@ -3130,70 +3221,74 @@ tr:hover td{ background: rgba(102,126,234,0.035); }
   position:absolute;
   left:50%;
   top:50%;
   width:20px;
   height:20px;
   transform: translate(-50%, -50%);
   border-radius:999px;
   background: var(--mkGlow, rgba(79,172,254,0.28));
 }

 /* Chips / consult */
 .chip{
   display:inline-flex;
   align-items:center;
   gap:8px;
   padding:6px 10px;
   border-radius:999px;
   font-weight:900;
   font-size:12px;
   border:1px solid rgba(20,22,30,0.06);
   white-space:nowrap;
 }
 .ct-owner{ background: rgba(148,163,184,0.16); color:#334155; }
 .ct-broker{ background: rgba(67,233,123,0.18); color:#0b7f6a; }
 .ct-relative{ background: rgba(250,112,154,0.16); color:#a43e73; }
+.ct-unknown{ background: rgba(148,163,184,0.22); color:#475569; }

 .rt-bn30{ background: rgba(34,197,94,0.18); color:#166534; }
 .rt-bgp{ background: rgba(147,51,234,0.18); color:#6b21a8; }
+.rt-unknown{ background: rgba(148,163,184,0.22); color:#475569; }

 .consult-badge{
   padding:7px 12px;
   border-radius:999px;
   font-size:12px;
   font-weight:900;
   display:inline-flex;
   align-items:center;
   gap:8px;
   border:1px solid rgba(20,22,30,0.06);
   white-space:nowrap;
 }
 .consult-badge i{ font-size:11px; opacity:0.9; }
 .cs-ok{ background: rgba(67,233,123,0.18); color:#0b7f6a; }
 .cs-fail{ background: rgba(255,88,88,0.18); color:#b83b2c; }
 .cs-care{ background: rgba(79,172,254,0.18); color:#0b6ea8; }

+.st-unknown{ background: rgba(148,163,184,0.2); color:#475569; }
+
 /* Action menu */
 .action-dropdown{ position:relative; }
 .action-btn{
   width:40px; height:40px;
   border-radius:14px;
   border:1px solid rgba(20,22,30,0.10);
   background: rgba(255,255,255,0.92);
   display:flex; align-items:center; justify-content:center;
   cursor:pointer;
   transition:0.18s ease;
 }
 .action-btn:hover{
   background: rgba(102,126,234,0.06);
   border-color: rgba(102,126,234,0.28);
   color:#3846c2;
 }
 .menu-pop{
   position:absolute;
   right:0; top:44px;
   min-width:210px;
   background: rgba(255,255,255,0.94);
   border:1px solid rgba(20,22,30,0.10);
   border-radius:16px;
   box-shadow: 0 8px 30px rgba(0,0,0,0.12);
   padding:8px;
@@ -3296,123 +3391,149 @@ tr:hover td{ background: rgba(102,126,234,0.035); }
 .editor-modal.create .mh-ico{ background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
 .editor-modal.detail .mh-ico{ background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }

 .modal-head h4{ font-size:15.4px; font-weight:900; margin:0; color:#0b1220; }
 .mh-sub{ margin:2px 0 0; font-size:12.5px; color:#5b6576; font-weight:650; }

 .modal-close{
   width:42px; height:42px;
   border-radius:14px;
   border:1px solid rgba(20,22,30,0.10);
   background: rgba(255,255,255,0.92);
   cursor:pointer;
 }

 /* BODY scroll fix */
 .modal-body{
   flex:1;
   overflow:auto;
   padding:16px;
 }
 .modal-body.grid{
   display:grid;
   grid-template-columns: 1.15fr 0.85fr;
   gap:14px;
   align-content:start;
+  align-items:stretch;
 }
 .modal-body.single{ display:block; }
 @media (max-width:920px){
   .modal-body.grid{ grid-template-columns: 1fr; }
 }

 .modal-card{
   background: rgba(255,255,255,0.92);
   border:1px solid rgba(20,22,30,0.10);
   border-radius:18px;
   padding:12px;
   box-shadow: 0 8px 30px rgba(0,0,0,0.10);
 }
 .detail-card{
   background: linear-gradient(135deg, rgba(255,255,255,0.92), rgba(255,255,255,0.86));
 }
+.detail-state{
+  grid-column: 1 / -1;
+  background: rgba(255,255,255,0.88);
+  border:1px solid rgba(20,22,30,0.10);
+  border-radius:18px;
+  padding:20px;
+  font-weight:800;
+  color:#334155;
+  display:flex;
+  align-items:center;
+  justify-content:center;
+  gap:10px;
+  box-shadow: 0 8px 24px rgba(0,0,0,0.08);
+}
+.detail-state.error{ color:#b83b2c; }

 .card-cap{
   display:inline-flex;
   gap:10px;
   align-items:center;
   padding:8px 10px;
   border-radius:14px;
   background: linear-gradient(135deg, rgba(102,126,234,0.12), rgba(118,75,162,0.10));
   border:1px solid rgba(102,126,234,0.16);
   font-weight:900;
   color:#2f3aa8;
   margin-bottom:10px;
 }

 .modal-panel{
   border:1px solid rgba(20,22,30,0.10);
   border-radius:18px;
   padding:12px;
   background: rgba(255,255,255,0.88);
   box-shadow: 0 8px 26px rgba(0,0,0,0.08);
   backdrop-filter: blur(10px);
   min-height: 260px;
+  height:100%;
+  display:flex;
+  flex-direction:column;
+  overflow:hidden;
 }
 .modal-panel h5{
   font-size:13px;
   font-weight:900;
   margin-bottom:8px;
   display:flex;
   align-items:center;
   gap:8px;
   color:#0b1220;
 }
 .history{
   display:flex;
   flex-direction:column;
   gap:8px;
-  max-height: 420px;
+  flex:1;
   overflow:auto;
   padding-right:4px;
 }
 .h-item{
   border:1px solid rgba(20,22,30,0.10);
   border-radius:16px;
   padding:10px;
   background: rgba(255,255,255,0.92);
   box-shadow: 0 8px 20px rgba(0,0,0,0.08);
 }
 .h-top{
   display:flex;
   justify-content:space-between;
   gap:10px;
   flex-wrap:wrap;
   font-weight:900;
   font-size:12px;
   color:#334155;
   margin-bottom:4px;
 }
+.h-meta{
+  display:flex;
+  flex-wrap:wrap;
+  gap:6px;
+  margin-bottom:6px;
+}
 .h-desc{ font-size:12.5px; color:#5b6576; font-weight:650; line-height:1.4; }
 .muted-empty{ font-weight:800; color:#93a2b8; font-size:12.5px; }
 .action-pill{
   display:inline-flex;
   align-items:center;
   padding:2px 8px;
   border-radius:999px;
   font-weight:800;
   font-size:11px;
   text-transform:uppercase;
   letter-spacing:0.02em;
 }
 .act-create{ background: rgba(67,233,123,0.2); color:#0b7f6a; }
 .act-edit{ background: rgba(102,126,234,0.18); color:#2f3aa8; }
 .act-status{ background: rgba(251,191,36,0.2); color:#a16207; }
 .act-reschedule{ background: rgba(79,172,254,0.2); color:#0b6ea8; }
 .act-note{ background: rgba(236,72,153,0.18); color:#9f1239; }
 .act-delete{ background: rgba(255,88,88,0.2); color:#b83b2c; }
 .act-other{ background: rgba(148,163,184,0.2); color:#334155; }

 .modal-foot{
   padding:14px 16px;
   border-top:1px solid rgba(20,22,30,0.10);
   display:flex;
   gap:10px;
@@ -3610,50 +3731,165 @@ tr:hover td{ background: rgba(102,126,234,0.035); }
   margin-top:12px;
   border-radius:18px;
   border:1px solid rgba(20,22,30,0.08);
   background: linear-gradient(135deg, rgba(79,172,254,0.14), rgba(102,126,234,0.10));
   padding:12px;
 }
 .note-cap{
   font-weight:950;
   color:#0b1220;
   display:flex;
   gap:8px;
   align-items:center;
   margin-bottom:6px;
 }
 .note-body{
   background: rgba(255,255,255,0.90);
   border:1px solid rgba(20,22,30,0.06);
   border-radius:16px;
   padding:10px;
   font-size:13px;
   color:#334155;
   font-weight:650;
   line-height:1.5;
 }

+/* Detail sections (compact, grouped) */
+.detail-section + .detail-section{
+  margin-top:12px;
+  padding-top:12px;
+  border-top:1px dashed rgba(148,163,184,0.35);
+}
+.section-head{
+  display:flex;
+  align-items:center;
+  gap:8px;
+  margin-bottom:8px;
+  color:#0b1220;
+}
+.section-divider{
+  height:2px;
+  width:100%;
+  border-radius:999px;
+  background: linear-gradient(90deg, #4facfe, #00f2fe);
+  margin-bottom:10px;
+  opacity:0.85;
+}
+.section-head h5{
+  margin:0;
+  font-size:13.5px;
+  font-weight:900;
+}
+.section-ico{
+  width:26px; height:26px;
+  border-radius:10px;
+  display:flex; align-items:center; justify-content:center;
+  color:#fff;
+  box-shadow: 0 8px 18px rgba(0,0,0,0.14);
+  flex:0 0 auto;
+}
+.section-ico i{ font-size:12px; }
+.si-appointment{ background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
+.si-customer{ background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
+.si-note{ background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
+.si-staff{ background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
+.si-file{ background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
+.section-sub{
+  margin-left:auto;
+  font-size:12px;
+  font-weight:800;
+  color:#64748b;
+}
+.section-grid{
+  display:grid;
+  grid-template-columns: 1fr 1fr;
+  gap:8px;
+}
+@media (max-width:560px){ .section-grid{ grid-template-columns: 1fr; } }
+.field-row{
+  display:flex;
+  flex-direction:column;
+  gap:4px;
+  padding:8px 10px;
+  border-radius:14px;
+  border:1px solid rgba(20,22,30,0.06);
+  background: rgba(255,255,255,0.92);
+}
+.field-label{
+  font-size:12px;
+  font-weight:800;
+  color:#5b6576;
+}
+.field-value{
+  font-size:13px;
+  font-weight:850;
+  color:#0b1220;
+  display:flex;
+  align-items:center;
+  gap:6px;
+  flex-wrap:wrap;
+}
+.note-grid{
+  display:grid;
+  grid-template-columns: repeat(2, minmax(0,1fr));
+  gap:10px;
+}
+@media (max-width:560px){ .note-grid{ grid-template-columns: 1fr; } }
+.note-card{
+  border-radius:16px;
+  border:1px solid rgba(20,22,30,0.06);
+  background: rgba(255,255,255,0.92);
+  padding:10px;
+}
+.note-title{
+  font-size:12px;
+  font-weight:900;
+  color:#334155;
+  margin-bottom:6px;
+}
+.file-list ul{
+  list-style:none;
+  padding:0;
+  margin:0;
+  display:flex;
+  flex-direction:column;
+  gap:6px;
+}
+.file-list li{
+  display:flex;
+  align-items:center;
+  gap:8px;
+  font-size:12.5px;
+  font-weight:750;
+  color:#334155;
+  padding:6px 8px;
+  border-radius:12px;
+  border:1px solid rgba(20,22,30,0.06);
+  background: rgba(255,255,255,0.92);
+}
+.file-list i{ color:#64748b; }
+
 /* Responsive */
 @media (max-width:768px){
   .filters{ align-items:flex-start; }
   .search-bar{ width:100%; }
 }
 .action-pill.act-create {
   background: linear-gradient(135deg, #22c55e, #16a34a);
   color: #fff;
 }

 .action-pill.act-edit {
   background: linear-gradient(135deg, #4facfe, #00f2fe);
   color: #fff;
 }
 .consult-badge.cs-none {
   background: linear-gradient(135deg, #e5e7eb, #d1d5db);
   color: #374151;
 }

 .consult-badge.cs-unknown {
   background: linear-gradient(135deg, #facc15, #f97316);
   color: #fff;
 }

 </style>
