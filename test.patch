diff --git a/src/components/dich-vu/Phi-dich-vu.vue b/src/components/dich-vu/Phi-dich-vu.vue
index 32eab75d577500316ad67bedaff3ed38b9512c5b..eda71864f3a10eec94bba7734be92a562545ad84 100644
--- a/src/components/dich-vu/Phi-dich-vu.vue
+++ b/src/components/dich-vu/Phi-dich-vu.vue
@@ -324,89 +324,94 @@
               </div>
               <div class="section-title">
                 <i class="fa-solid fa-briefcase"></i>
                 Dịch vụ & giá trị
               </div>

               <div class="field">
                 <label class="field-label">
                   <span class="label-ico tone-indigo"><i class="fa-solid fa-list"></i></span>
                   <span>Dịch vụ</span>
                 </label>
                 <select v-model="newContract.serviceId">
                   <option v-for="service in serviceOptions" :key="service.id || service.name" :value="service.id || service.name">
                     {{ service.name }}
                   </option>
                 </select>
                 <div class="muted tiny">Dịch vụ lấy từ hệ thống, giá gốc dựa theo phân khúc.</div>
               </div>

               <div class="grid grid-cols-1 md:grid-cols-2 gap-3 px-3 pb-2">
                 <div class="field !m-0">
                   <label class="field-label">
                     <span class="label-ico tone-teal"><i class="fa-solid fa-building"></i></span>
                     <span>Giá trị tài sản chấp nhận ký bán</span>
                   </label>
-                  <input v-model.number="newContract.giaTriTaiSan" type="number" min="0" placeholder="VD: 1500000000">
+                  <input
+                    :value="formatNumberInput(newContract.giaTriTaiSan)"
+                    type="text"
+                    inputmode="numeric"
+                    placeholder="VD: 1.500.000.000"
+                    @input="newContract.giaTriTaiSan = parseNumberInput($event.target.value)"
+                  >
                   <div class="muted tiny">Nhập giá trị tài sản để xác định phân khúc.</div>
                 </div>

                 <div class="field !m-0">
                   <label class="field-label">
                     <span class="label-ico tone-orange"><i class="fa-solid fa-money-bill-wave"></i></span>
                     <span>Giá gốc</span>
                   </label>
                   <input :value="formatMoney(newContract.giaDichVuGoc)" type="text" readonly>
                   <div class="muted tiny">&nbsp;</div>
                 </div>
               </div>

               <div class="grid grid-cols-1 md:grid-cols-2 gap-3 px-3 pb-2">
                 <div class="field !m-0">
                   <label class="field-label">
                     <span class="label-ico tone-pink"><i class="fa-solid fa-tags"></i></span>
                     <span>Giảm giá</span><div class="discount-toggle">
                     <button type="button" :class="{ active: newContract.discountMode === 'MONEY' }" @click="setDiscountMode('MONEY')">
                       <i class="fa-solid fa-money-bill-wave"></i>
                       Tiền
                     </button>
                     <button type="button" :class="{ active: newContract.discountMode === 'PERCENT' }" @click="setDiscountMode('PERCENT')">
                       <i class="fa-solid fa-percent"></i>
                       %
                     </button>
                   </div>
                   </label>
                   <div class="discount-input">

                     <div class="discount-value">
                       <input
-                        v-model.number="newContract.discountValue"
-                        type="number"
-                        :min="newContract.discountMode === 'PERCENT' ? 0 : 1"
-                        :max="newContract.discountMode === 'PERCENT' ? 100 : (newContract.giaDichVuGoc || 0)"
-                        :placeholder="newContract.discountMode === 'PERCENT' ? 'VD: 10' : 'VD: 1000000'"
-                        @input="updateGiaSauGiam"
+                        :value="newContract.discountMode === 'PERCENT' ? newContract.discountValue : formatNumberInput(newContract.discountValue)"
+                        type="text"
+                        inputmode="numeric"
+                        :placeholder="newContract.discountMode === 'PERCENT' ? 'VD: 10' : 'VD: 1.000.000'"
+                        @input="setDiscountValueFromInput($event.target.value)"
                       >
                       <span class="discount-suffix">{{ newContract.discountMode === 'PERCENT' ? '%' : '₫' }}</span>
                     </div>
                   </div>
                   <div class="muted tiny">
                     {{ newContract.discountMode === 'PERCENT'
                       ? 'Giới hạn 0 - 100%.' : 'Giới hạn > 0 và không vượt quá giá gốc.' }}
                   </div>
                 </div>

                 <div class="field !m-0">
                   <label class="field-label" style="margin-top: 7px !important;">
                     <span class="label-ico tone-purple"><i class="fa-solid fa-circle-dollar-to-slot"></i></span>
                     <span>Giá sau giảm</span>
                   </label>
                   <input style="margin-top: 6px !important;" :value="formatMoney(newContract.giaSauGiam)" type="text" readonly >
                   <div class="muted tiny">&nbsp;</div>
                 </div>
               </div>

               <div class="segment-hint" v-if="segmentHint">
                 <i class="fa-solid fa-circle-info"></i>
                 {{ segmentHint }}
               </div>

@@ -476,133 +481,145 @@
           <button class="btn primary" @click="saveContract">
             <i class="fa-solid fa-floppy-disk"></i> Lưu hợp đồng
           </button>
         </div>
       </div>
     </div>

     <!-- MODAL: PAY -->
     <div class="modal" :class="{ show: showModal === 'modalPay' }" @click.self="closeModal('modalPay')">
       <div class="modal-card pay-modal">
         <div class="modal-h">
           <div class="modal-title">
             <i class="fa-solid fa-circle-dollar-to-slot"></i>
             Đóng phí
           </div>
           <button class="x" @click="closeModal('modalPay')">
             <i class="fa-solid fa-xmark"></i>
           </button>
         </div>
         <div class="modal-b">
           <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
             <div class="card">
               <div class="card-h"><i class="fa-solid fa-receipt"></i> Thông tin đợt đóng</div>
               <div class="field">
                 <label><i class="fa-solid fa-money-bill"></i> Số tiền đóng</label>
-                <input v-model.number="payment.amount" type="number" placeholder="VD: 3000000">
+                <input
+                  :value="formatNumberInput(payment.amount)"
+                  type="text"
+                  inputmode="numeric"
+                  placeholder="VD: 3.000.000"
+                  @input="setPaymentAmountFromInput($event.target.value)"
+                >
               </div>
               <div class="field">
                 <label><i class="fa-solid fa-credit-card"></i> Hình thức thanh toán</label>
                 <select v-model="payment.method">
                   <option value="TIEN_MAT">Tiền mặt</option>
                   <option value="CHUYEN_KHOAN">Chuyển khoản</option>
                 </select>
               </div>
               <div class="field">
                 <label><i class="fa-solid fa-calendar-day"></i> Ngày đóng tiền</label>
                 <input v-model="payment.date" type="date">
               </div>
               <div class="field">
                 <label><i class="fa-solid fa-note-sticky"></i> Ghi chú</label>
                 <input v-model="payment.note" type="text" placeholder="VD: Đợt 2">
               </div>
             </div>

             <div class="card">
               <div class="card-h"><i class="fa-solid fa-circle-info"></i> Tóm tắt hợp đồng</div>
               <div class="p-3">
                 <div class="text-sm font-extrabold">{{ currentContract?.maHopDong }} • {{ currentContract?.tenKhachHang }}</div>
                 <div class="muted tiny mt-1">{{ currentContract?.tenDichVu }} • Ngày tạo {{ formatCreatedAt(currentContract?.ngayTao) }} • Trạng thái {{ getStatusText(currentContract?.trangThaiHopDong) }}</div>

                 <div class="grid grid-cols-2 gap-2 mt-3">
                   <div class="kpi">
                     <div class="k"><span class="dot"></span>Giá sau giảm</div>
                     <div class="v price p4">{{ formatMoney(currentContract?.giaSauGiam || 0) }}</div>
                   </div>
                   <div class="kpi">
                     <div class="k"><span class="dot"></span>Tổng điều chỉnh</div>
                     <div class="v price p2">{{ formatMoney(calcTongDieuChinh(currentContract)) }}</div>
                   </div>
                   <div class="kpi">
-                    <div class="k"><span class="dot"></span>Còn thiếu</div>
-                    <div class="v price p1">{{ formatMoney(Math.max(0, calcGiaDieuChinh(currentContract) - calcThucThu(currentContract))) }}</div>
-                  </div>
-                  <div class="kpi">
-                    <div class="k"><span class="dot"></span>Đã thu</div>
-                    <div class="v price p3">{{ formatMoney(calcThucThu(currentContract)) }}</div>
-                  </div>
+                  <div class="k"><span class="dot"></span>Còn thiếu</div>
+                  <div class="v price p1">{{ formatMoney(calcConThieu(currentContract)) }}</div>
+                </div>
+                <div class="kpi">
+                  <div class="k"><span class="dot"></span>Đã thu</div>
+                  <div class="v price p3">{{ formatMoney(getDoanhThuRow(currentContract)) }}</div>
+                </div>
                 </div>

                 <div class="note mt-3">
                   <b>Lưu ý:</b> Đóng phí sẽ làm tăng <span class="mono">Thực thu</span>.
                 </div>
               </div>
             </div>
           </div>
         </div>

         <div class="modal-f">
           <button class="btn ghost" @click="closeModal('modalPay')">
             <i class="fa-solid fa-ban"></i> Hủy
           </button>
           <button class="btn primary" @click="savePayment">
             <i class="fa-solid fa-check"></i> Xác nhận đóng
           </button>
         </div>
       </div>
     </div>

     <!-- MODAL: REFUND -->
     <div class="modal" :class="{ show: showModal === 'modalRefund' }" @click.self="closeModal('modalRefund')">
       <div class="modal-card">
         <div class="modal-h">
           <div class="modal-title">
             <i class="fa-solid fa-arrow-rotate-left"></i>
             Hoàn phí
           </div>
           <button class="x" @click="closeModal('modalRefund')">
             <i class="fa-solid fa-xmark"></i>
           </button>
         </div>

         <div class="modal-b">
           <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
             <div class="card">
               <div class="card-h"><i class="fa-solid fa-reply"></i> Thông tin hoàn</div>
               <div class="field">
                 <label><i class="fa-solid fa-money-bill-transfer"></i> Số tiền hoàn</label>
-                <input v-model.number="refund.amount" type="number" placeholder="VD: 500000">
+                <input
+                  :value="formatNumberInput(refund.amount)"
+                  type="text"
+                  inputmode="numeric"
+                  placeholder="VD: 500.000"
+                  @input="refund.amount = parseNumberInput($event.target.value)"
+                >
               </div>
               <div class="field">
                 <label><i class="fa-solid fa-calendar-day"></i> Ngày hoàn</label>
                 <input v-model="refund.date" type="date">
               </div>
               <div class="field">
                 <label><i class="fa-solid fa-clipboard"></i> Lý do hoàn</label>
                 <textarea v-model="refund.reason" placeholder="VD: Khách huỷ 1 phần..."></textarea>
               </div>
             </div>

             <div class="card">
               <div class="card-h"><i class="fa-solid fa-circle-info"></i> Tóm tắt hợp đồng</div>
               <div class="p-3">
                 <div class="text-sm font-extrabold">{{ currentContract?.maHopDong }} • {{ currentContract?.tenKhachHang }}</div>
                 <div class="muted tiny mt-1">{{ currentContract?.tenDichVu }} • Ngày tạo {{ formatCreatedAt(currentContract?.ngayTao) }} • Trạng thái {{ getStatusText(currentContract?.trangThaiHopDong) }}</div>

                 <div class="grid grid-cols-2 gap-2 mt-3">
                   <div class="kpi">
                     <div class="k"><span class="dot"></span>Giá điều chỉnh</div>
                     <div class="v price p2">{{ formatMoney(calcGiaDieuChinh(currentContract)) }}</div>
                   </div>
                   <div class="kpi">
                     <div class="k"><span class="dot"></span>Thực thu</div>
                     <div class="v price p3">{{ formatMoney(calcThucThu(currentContract)) }}</div>
@@ -634,51 +651,57 @@
           </button>
         </div>
       </div>
     </div>

     <!-- MODAL: ADJUST -->
     <div class="modal" :class="{ show: showModal === 'modalAdjust' }" @click.self="closeModal('modalAdjust')">
       <div class="modal-card">
         <div class="modal-h">
           <div class="modal-title">
             <i class="fa-solid fa-sliders"></i>
             Điều chỉnh hợp đồng
           </div>
           <button class="x" @click="closeModal('modalAdjust')">
             <i class="fa-solid fa-xmark"></i>
           </button>
         </div>

         <div class="modal-b">
           <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
             <div class="card">
               <div class="card-h"><i class="fa-solid fa-pen-to-square"></i> Thông tin điều chỉnh</div>

               <div class="field">
                 <label><i class="fa-solid fa-coins"></i> Số tiền điều chỉnh</label>
-                <input v-model.number="adjustment.amount" type="number" placeholder="VD: -500000 hoặc 300000">
+                <input
+                  :value="formatNumberInput(adjustment.amount)"
+                  type="text"
+                  inputmode="numeric"
+                  placeholder="VD: -500.000 hoặc 300.000"
+                  @input="adjustment.amount = parseNumberInput($event.target.value, true)"
+                >
                 <div class="muted tiny">Âm = giảm thêm • Dương = phụ thu / phạt</div>
               </div>

               <div class="field">
                 <label><i class="fa-solid fa-layer-group"></i> Loại điều chỉnh</label>
                 <select v-model="adjustment.type">
                   <option value="GIAM_GIA">GIAM_GIA</option>
                   <option value="PHU_THU">PHU_THU</option>
                   <option value="PHAT">PHAT</option>
                 </select>
               </div>

               <div class="field">
                 <label><i class="fa-solid fa-clipboard"></i> Lý do</label>
                 <textarea v-model="adjustment.reason" placeholder="VD: Phạt trễ tiến độ..."></textarea>
               </div>
             </div>

             <div class="card">
               <div class="card-h"><i class="fa-solid fa-circle-info"></i> Tác động sau điều chỉnh</div>
               <div class="p-3">
                 <div class="text-sm font-extrabold">{{ currentContract?.maHopDong }} • {{ currentContract?.tenKhachHang }}</div>
                 <div class="muted tiny mt-1">{{ currentContract?.tenDichVu }} • Ngày tạo {{ formatCreatedAt(currentContract?.ngayTao) }} • Trạng thái {{ getStatusText(currentContract?.trangThaiHopDong) }}</div>

                 <div class="grid grid-cols-2 gap-2 mt-3">
@@ -1150,50 +1173,69 @@ export default {
       }, 250)
     },

     'newContract.serviceId'() {
       this.updateServicePrice()
     },

     'newContract.giaTriTaiSan'() {
       this.updateGiaGocFromAsset()
     },

     'newContract.discountMode'() {
       this.updateGiaSauGiam()
     }
   },

   methods: {
     // Helper functions
     formatMoney(n) {
       const x = Math.round(Number(n || 0))
       const sign = x < 0 ? '-' : ''
       const abs = Math.abs(x)
       return sign + abs.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.') + ' ₫'
     },

+    formatNumberInput(n) {
+      if (n === null || n === undefined || n === '') return ''
+      const x = Math.round(Number(n || 0))
+      const sign = x < 0 ? '-' : ''
+      const abs = Math.abs(x)
+      return sign + abs.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.')
+    },
+
+    parseNumberInput(value, allowNegative = false) {
+      const raw = String(value || '').trim()
+      if (!raw) return 0
+      const noDots = raw.replace(/\./g, '')
+      const cleaned = allowNegative ? noDots.replace(/[^0-9-]/g, '') : noDots.replace(/[^0-9]/g, '')
+      let parsed = Number(cleaned)
+      if (Number.isNaN(parsed)) parsed = 0
+      if (!allowNegative) return Math.max(0, parsed)
+      return parsed
+    },
+
     initials(name) {
       const parts = String(name || '')
           .trim()
           .split(/\s+/)
           .filter(Boolean)
       if (parts.length === 0) return 'NA'
       if (parts.length === 1) return parts[0].slice(0, 2).toUpperCase()
       return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase()
     },

     getStatusText(status) {
       switch(status) {
         case 'DANG_HIEU_LUC': return 'Đang hiệu lực'
         case 'HOAN_TAT': return 'Hoàn tất'
         case 'HUY': return 'Đã hủy'
         default: return status
       }
     },

     todayISO() {
       const d = new Date()
       const yyyy = d.getFullYear()
       const mm = String(d.getMonth() + 1).padStart(2, '0')
       const dd = String(d.getDate()).padStart(2, '0')
       return `${yyyy}-${mm}-${dd}`
@@ -1219,50 +1261,54 @@ export default {
       return String(value)
     },

     getGiaGiam(contract) {
       return Number(contract?.giaGiam ?? contract?.phiGiam ?? 0)
     },

     getGiaTaiSanKy(contract) {
       return Number(contract?.giaTaiSanKyGoc ?? contract?.giaTriTaiSan ?? contract?.giaTriKyBan ?? 0)
     },

     getTongHoan(contract) {
       if (contract?.giaHoanTien !== undefined && contract?.giaHoanTien !== null) {
         return Number(contract.giaHoanTien || 0)
       }
       return this.calcTongHoan(contract)
     },

     getTongDieuChinh(contract) {
       if (contract?.tongDC !== undefined && contract?.tongDC !== null) {
         return Number(contract.tongDC || 0)
       }
       return this.calcTongDieuChinh(contract)
     },

+    getDoanhThuRow(contract) {
+      return Number(contract?.doanhThu ?? 0)
+    },
+
     getDoanhThu(contract) {
       if (contract?.doanhThu !== undefined && contract?.doanhThu !== null) {
         return Number(contract.doanhThu || 0)
       }
       return this.calcThucThu(contract)
     },

     getDoanhSo(contract) {
       if (contract?.doanhSo !== undefined && contract?.doanhSo !== null) {
         return Number(contract.doanhSo || 0)
       }
       return this.calcDoanhThu(contract)
     },

     randInt(min, max) {
       return Math.floor(Math.random() * (max - min + 1)) + min
     },

     randPriceForService(serviceName) {
       const svc = this.serviceOptions.find(s => s.name === serviceName) || this.serviceOptions[0]
       if (!svc) return 0
       const min = Number(svc.minPrice ?? svc.min ?? 0)
       const max = Number(svc.maxPrice ?? svc.max ?? min)
       if (!min || !max) return 0
       const step = 250000
@@ -1358,50 +1404,57 @@ export default {
     // Calculation functions
     calcTongDong(c) {
       return (c?.dotDongTien || []).reduce((sum, x) => sum + (Number(x.soTienDong) || 0), 0)
     },

     calcTongHoan(c) {
       return (c?.hoanTien || []).reduce((sum, x) => sum + (Number(x.soTienHoan) || 0), 0)
     },

     calcTongDieuChinh(c) {
       return (c?.dieuChinh || []).reduce((sum, x) => sum + (Number(x.soTienDieuChinh) || 0), 0)
     },

     calcThucThu(c) {
       return this.calcTongDong(c) - this.calcTongHoan(c)
     },

     calcGiaDieuChinh(c) {
       return (Number(c?.giaSauGiam) || 0) + this.calcTongDieuChinh(c)
     },

     calcDoanhThu(c) {
       return Math.min(this.calcGiaDieuChinh(c), this.calcThucThu(c))
     },

+    calcConThieu(c) {
+      const giaSauGiam = Number(c?.giaSauGiam || 0)
+      const tongDieuChinh = this.getTongDieuChinh(c)
+      const doanhThu = this.getDoanhThuRow(c)
+      return Math.max(0, giaSauGiam + tongDieuChinh - doanhThu)
+    },
+
     // Toast
     showToastMessage(type, title, text) {
       this.toast = {
         type,
         title,
         text,
         icon: type === 'success' ? 'fa-solid fa-circle-check' :
             type === 'error' ? 'fa-solid fa-triangle-exclamation' :
                 'fa-solid fa-circle-info'
       }
       this.showToast = true
       setTimeout(() => {
         this.showToast = false
       }, 3000)
     },

     // Modal control
     openModal(modal) {
       this.showModal = modal
     },

     closeModal(modal) {
       this.resetContractForm()
       if (this.showModal === modal) {
         this.showModal = null
@@ -1453,50 +1506,65 @@ export default {
         this.newContract.giaDichVuGoc = 0
       }
       this.updateGiaSauGiam()
     },

     setDiscountMode(mode) {
       this.newContract.discountMode = mode
     },

     updateGiaSauGiam() {
       const giaGoc = Number(this.newContract.giaDichVuGoc || 0)
       if (this.newContract.discountMode === 'PERCENT') {
         const percent = Math.max(0, Math.min(100, Number(this.newContract.discountValue || 0)))
         this.newContract.discountValue = percent
         this.newContract.phiGiam = Math.round(giaGoc * (percent / 100))
       } else {
         const money = Number(this.newContract.discountValue || 0)
         const clamped = Math.max(0, Math.min(giaGoc, money))
         this.newContract.discountValue = clamped
         this.newContract.phiGiam = clamped
       }
       this.newContract.giaSauGiam = Math.max(0, giaGoc - (this.newContract.phiGiam || 0))
       this.updateFirstPayment()
     },

+    setDiscountValueFromInput(value) {
+      if (this.newContract.discountMode === 'PERCENT') {
+        this.newContract.discountValue = this.parseNumberInput(value)
+      } else {
+        this.newContract.discountValue = this.parseNumberInput(value)
+      }
+      this.updateGiaSauGiam()
+    },
+
+    setPaymentAmountFromInput(value) {
+      const parsed = this.parseNumberInput(value)
+      const maxAmount = this.calcConThieu(this.currentContract)
+      this.payment.amount = Math.min(parsed, maxAmount)
+    },
+
     updateFirstPayment() {
       // Handled by computed property
     },

     clearSelectedCustomer() {
       this.selectedCustomer = null
       this.customerSearch = ''
       this.customerSearchResults = []
       this.customerSearchError = ''
       this.customerSearchLoading = false
       this.newContract.maKhachHang = ''
       this.newContract.tenKhachHang = ''
     },

     async fetchCustomerSearch(keyword) {
       const k = (keyword || '').trim()
       if (!k) {
         this.customerSearchResults = []
         this.customerSearchError = ''
         return
       }

       if (k === this.lastCustomerKeyword) return
       this.lastCustomerKeyword = k

@@ -1632,50 +1700,56 @@ export default {

       } catch (error) {
         console.error('❌ Lỗi tạo hợp đồng', error)
         updateAlertError('Tạo hợp đồng thất bại', 'Vui lòng thử lại sau.')
       }
     },

     // Payment management
     openPay(contract) {
       this.currentContract = contract
       this.payment = {
         amount: 0,
         method: 'CHUYEN_KHOAN',
         date: this.todayISO(),
         note: ''
       }
       this.openModal('modalPay')
     },

     async savePayment() {
       if (this.payment.amount <= 0) {
         this.showToastMessage('error', 'Số tiền không hợp lệ', 'Số tiền đóng phải > 0.')
         return
       }

+      const maxAmount = this.calcConThieu(this.currentContract)
+      if (this.payment.amount > maxAmount) {
+        this.showToastMessage('error', 'Số tiền vượt quá còn thiếu', `Tối đa còn thiếu: ${this.formatMoney(maxAmount)}.`)
+        return
+      }
+
       const contractIndex = this.contracts.findIndex(c => c.id === this.currentContract.id)
       if (contractIndex === -1) return

       const payload = {
         hopDongId: this.currentContract.id,
         soTienDong: this.payment.amount,
         hinhThucThanhToan: this.payment.method,
         ngayDongTien: this.payment.date || this.todayISO(),
         ghiChu: this.payment.note
       }

       try {
         await showLoading(api.post('/hop-dong/admin/dong-phi', payload))
         this.contracts[contractIndex].dotDongTien.push({
           id: crypto.randomUUID(),
           soTienDong: this.payment.amount,
           hinhThucThanhToan: this.payment.method,
           ngayDongTien: payload.ngayDongTien,
           ghiChu: this.payment.note,
           nguoiGhiNhan: 'demo_admin',
           ngayTao: new Date().toLocaleString('vi-VN')
         })
         updateAlertSuccess('Đóng phí thành công', `+${this.formatMoney(this.payment.amount)} (${this.payment.method})`)
         await this.fetchContracts()
         this.closeModal('modalPay')
